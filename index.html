<script>
/* ==========================
   RNG (unchanged)
========================== */
function xmur3(str){ for(var i=0,h=1779033703^str.length;i<str.length;i++){ h=Math.imul(h^str.charCodeAt(i),3432918353); h=h<<13|h>>>19; } return function(){ h=Math.imul(h^h>>>16,2246822507); h=Math.imul(h^h>>>13,3266489909); return (h^h>>>16)>>>0; } }
function mulberry32(a){ return function(){ var t=a+=0x6D2B79F5; t=Math.imul(t^t>>>15,t|1); t^=t+Math.imul(t^t>>>7,t|61); return ((t^t>>>14)>>>0)/4294967296; } }

/* ==========================
   STORY BRAIN WRAPPER
========================== */
function runStoryBrain(state, rng) {
  const contract = createStoryContract(state, rng);
  const logic = createStoryLogic(contract);
  const world = createWorldState(contract);
  return { contract, logic, world };
}

/* ==========================
   SCENE GENERATION (NO RANDOM)
========================== */
function generateScenesFromBrain(brain, state) {
  const scenes = [];
  let emotion = "curious";

  brain.logic.forEach((node, i) => {
    let text = "";

    switch (node.id) {
      case "notice":
        text = `Calm opening in ${brain.contract.location}. Willy notices the problem.`;
        break;

      case "try_alone":
        text = `Willy tries to fix the problem alone using his paws. It does not work.`;
        emotion = nextEmotion(emotion);
        break;

      case "emotion_low":
        text = `Willy pauses. His ears lower. He looks unsure.`;
        emotion = nextEmotion(emotion);
        break;

      case "decision":
        text = `Willy looks at the problem, then looks around as if deciding to ask for help.`;
        break;

      case "helper":
        text = `${state.helperAnimal} arrives calmly after noticing Willy.`;
        break;

      case "wrong_fix":
        text = `${state.helperAnimal} tries a first fix. It fails safely.`;
        break;

      case "adjust":
        text = `${state.helperAnimal} adjusts the approach carefully.`;
        break;

      case "success":
        text = `The fix works. The problem is resolved safely.`;
        emotion = nextEmotion(emotion);
        break;

      case "payoff":
        text = `Willy relaxes. His tail wags. The tiny blep returns.`;
        emotion = nextEmotion(emotion);
        break;
    }

    scenes.push(`Scene ${i + 1}: ${text}`);
  });

  return scenes;
}

/* ==========================
   MAIN GENERATE FUNCTION
========================== */
function generateStory(sceneCount) {
  const seedStr = document.getElementById("seed").value;
  const seed = xmur3(seedStr)();
  const rng = mulberry32(seed);

  let state = {
    problem: pick(rng, PROBLEMS),
    location: pick(rng, LOCATIONS),
    weather: pick(rng, WEATHER),
    helperRole: pick(rng, ROLES),
    helperAnimal: pick(rng, HELPER_ANIMALS_BASE),
    object: pick(rng, OBJECTS_BASE),
    useObject: document.getElementById("useObject").checked,
    useCountry: false
  };

  state = validateAndFix(state, rng);

  const brain = runStoryBrain(state, rng);
  const scenes = generateScenesFromBrain(brain, state);

  renderStory(brain, state, scenes);
}

/* ==========================
   RENDER OUTPUT (UNCHANGED FORMAT)
========================== */
function renderStory(brain, state, scenes) {
  const out = [];

  out.push("STORY TITLE");
  out.push(`Willy and the Little Problem\n`);

  out.push("STORY SETTINGS");
  out.push(`- Hero: Willy`);
  out.push(`- Location: ${brain.contract.location}`);
  out.push(`- Weather/Time: ${brain.contract.weather}`);
  out.push(`- Helper (animal-only): ${state.helperAnimal}`);
  out.push(`- Primary Helper Role: ${state.helperRole}`);
  out.push(`- Problem: ${state.problem}`);
  if (state.useObject) out.push(`- Object of affection: ${state.object}`);
  out.push("");

  out.push(`SCENES (${scenes.length})`);
  scenes.forEach(s => out.push(s));

  document.getElementById("out").textContent = out.join("\n");
}

/* ==========================
   BUTTON HOOKS
========================== */
document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("btn15").onclick = () => generateStory(15);
  document.getElementById("btn20").onclick = () => generateStory(20);
  document.getElementById("btn25").onclick = () => generateStory(25);
});

</script>
