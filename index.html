<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Silent Cinematic Cute Story Generator v3</title>
  <style>
    :root { --pad: 14px; --r: 14px; --bg:#0b0d12; --fg:#eef2ff; --mut:rgba(255,255,255,.75); --bd:rgba(255,255,255,.12); }
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg);line-height:1.35}
    header{padding:22px 18px;border-bottom:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,.22), transparent 60%),
        radial-gradient(800px 400px at 80% 0%, rgba(16,185,129,.18), transparent 55%);
    }
    header h1{margin:0 0 6px;font-size:22px}
    header p{margin:0;opacity:.85;max-width:980px}
    a{color:#a5b4fc;text-decoration:none}
    a:hover{text-decoration:underline}
    main{max-width:1200px;margin:0 auto;padding:18px;display:grid;gap:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media (min-width:980px){ .grid{grid-template-columns:520px 1fr} }
    .card{background:rgba(255,255,255,.04);border:1px solid rgba(255,255,255,.10);border-radius:var(--r);padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:15px;opacity:.95}
    label{font-size:12px;opacity:.85;display:block;margin:10px 0 6px}
    input,select,textarea{
      width:100%;padding:10px 11px;border-radius:12px;border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);color:var(--fg);outline:none;box-sizing:border-box
    }
    textarea{min-height:92px;resize:vertical;white-space:pre-wrap}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:700px){ .row.two{grid-template-columns:1fr 1fr} .row.three{grid-template-columns:1fr 1fr 1fr} }
    .btnbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px;align-items:center}
    button{
      border:1px solid rgba(255,255,255,.14);background:rgba(255,255,255,.06);color:var(--fg);
      padding:10px 12px;border-radius:12px;cursor:pointer;font-weight:800
    }
    button.primary{background:rgba(99,102,241,.22);border-color:rgba(99,102,241,.45)}
    button.good{background:rgba(16,185,129,.18);border-color:rgba(16,185,129,.40)}
    button.special{background:rgba(165,180,252,0.2);color:#a5b4fc;border:1px solid #a5b4fc}
    button:hover{filter:brightness(1.08)}
    .pill{display:inline-flex;gap:8px;align-items:center;padding:7px 10px;border-radius:999px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04)}
    .muted{opacity:.78}
    .small{font-size:12px;opacity:.80}
    .k{color:#a5b4fc;font-weight:800}
    .out{white-space:pre-wrap;background:rgba(0,0,0,.35);border:1px solid rgba(255,255,255,.10);border-radius:12px;padding:12px;font-size:13px;overflow:auto}
    .toggle{display:flex;gap:10px;align-items:center;user-select:none;margin-top:8px}
    .toggle input{width:auto}
    .warn{color:#fbbf24}
    .ok{color:#34d399}
    .err{color:#fb7185}
    .hr{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
  </style>
</head>

<body>
  <header>
    <h1>Silent Cinematic Cute Story Generator</h1>
    <p>
      Brand-locked to <span class="k">Willy</span> (+ friends Panby/Quok optional). 
      <br>
      <a href="./compiler.html">Open Prompt Compiler ‚Üí</a>
    </p>
  </header>

  <main class="grid">
    <section class="card">
      <h2>1) Controls</h2>
      <div class="row two">
        <div>
          <label>Story Type (tone)</label>
          <select id="storyType"></select>
        </div>
        <div>
          <label>Seed (Auto-increment)</label>
          <input id="seed" value="willy-001" />
        </div>
      </div>

      <div class="row two">
        <div>
          <label>Friends (optional)</label>
          <select id="friends"></select>
        </div>
        <div>
          <label>Scenes</label>
          <div class="btnbar">
            <button class="primary" id="btn15">15 scenes</button>
            <button class="primary" id="btn20">20 scenes</button>
            <button class="primary" id="btn25">25 scenes</button>
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="toggle">
        <input type="checkbox" id="manualOverride" />
        <label for="manualOverride" style="margin:0">Manual override (advanced).</label>
      </div>

      <div id="manualPanel" style="display:none;margin-top:10px">
        <div class="row two">
          <div><label>Problem</label><select id="problem"></select></div>
          <div><label>Helper Role</label><select id="helperRole"></select></div>
        </div>
        <div class="row two">
          <div><label>Helper Animal</label><select id="helperAnimal"></select></div>
          <div><label>Weather</label><select id="weather"></select></div>
        </div>
        <div class="row">
          <label>Location</label><select id="location"></select>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row two">
        <div>
          <label>Object of affection</label>
          <select id="objectAffection"></select>
        </div>
        <div class="toggle" style="margin-top:32px">
          <input type="checkbox" id="useObject" checked />
          <label for="useObject" style="margin:0">Include object</label>
        </div>
      </div>

      <div class="pill">
        <span>Status:</span>
        <span id="status" class="muted">Ready</span>
      </div>
    </section>

    <section class="card">
      <h2>2) Output ‚Äî Story Frame</h2>
      <div class="btnbar">
        <button id="copyStory" class="good">Copy Story</button>
        <button id="btnGoToCompiler" class="special">üöÄ Send to Compiler ‚Üí</button>
      </div>
      <div id="out" class="out" style="margin-top:12px">Click ‚Äú15 scenes‚Äù to generate...</div>
    </section>
  </main>

<script>
/* --- CORE RNG & DATA LIBRARIES (Your Original Core) --- */
function xmur3(str){for(var i=0,h=1779033703^str.length;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=h<<13|h>>>19;}return function(){h=Math.imul(h^h>>>16,2246822507);h=Math.imul(h^h>>>13,3266489909);return (h^h>>>16)>>>0;}}
function mulberry32(a){return function(){var t=a+=0x6D2B79F5;t=Math.imul(t^t>>>15,t|1);t^=t+Math.imul(t^t>>>7,t|61);return ((t^t>>>14)>>>0)/4294967296;}}
function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)] }
function chance(rng, p){ return rng() < p }

const STORY_TYPES = ["Adventure (gentle quest)", "Funny safe mishap", "Emotional (caregiving)", "Brave (scary-but-safe)", "Friendship"];
const FRIENDS_OPTIONS = ["Auto (story decides)", "None", "Panby only", "Quok only", "Panby + Quok"];
const BASE_PROBLEMS = ["A toy plane propeller is bent", "A wagon is stuck in mud", "A kite string is tangled in a bush", "A bridge plank is loose"];
const BASE_ROLES = ["Carpenter", "Mechanic", "Toy Maker", "Medic", "Lifeguard", "Bridge Builder"];
const HELPER_ANIMALS_BASE = ["beaver builder helper", "bunny medic helper", "red panda mechanic helper", "otter lifeguard helper"];
const WEATHER = ["Golden hour evening", "Spring morning, soft sunlight", "Light rain, puddles", "Snowy day, soft snowfall"];
const LOCATIONS = ["Park meadow", "Riverside path", "Cozy workshop", "Snowy forest clearing"];
const OBJECTS_BASE = ["tiny plush buddy", "mini paint palette", "small wooden boat", "tiny lantern"];

/* --- SMART NARRATIVE INJECTION (The "Smarter" Part) --- */
const ROLE_ACTIONS = {
  "Mechanic": { approach: "inspects the moving parts", action: "tightens the bolt", icon: "üîß" },
  "Carpenter": { approach: "aligns the wood grain", action: "taps the mallet", icon: "üî®" },
  "Medic": { approach: "checks the surface for scratches", action: "applies a soft patch", icon: "ü©π" },
  "Lifeguard": { approach: "scans the water safety", action: "tosses the rescue line", icon: "üõü" },
  "Bridge Builder": { approach: "tests the support tension", action: "secures the rope", icon: "üåâ" }
};

const EMOTIONAL_BEATS = {
  "worried": ["ears droop slightly", "tail stills", "tiny blep disappears", "shoulders slump"],
  "hopeful": ["ears perk up", "head tilts", "tail gives one small wag", "eyes widen"],
  "joyous": ["rapid tail wag", "happy hop", "tiny pink blep returns", "soft eyes"]
};

function buildSceneArc(state, n, rng){
  const hero = "Willy (Baby Golden Retriever)";
  const helper = state.helperAnimal;
  const roleData = ROLE_ACTIONS[state.helperRole] || { approach: "looks closely", action: "helps out" };
  const obj = state.useObject ? state.object : "the situation";
  
  const beats = [];
  
  // 1-5: Setup & Conflict
  beats.push(`Scene 1: ${state.location}. ${hero} sits under ${state.weather}. He looks content.`);
  beats.push(`Scene 2: ${hero} spots ${obj}. He trots forward with a happy tail wag.`);
  beats.push(`Scene 3: The conflict appears: ${state.problem}. ${hero} tries to fix it with a paw, but it's stuck.`);
  beats.push(`Scene 4: EMOTION: ${hero} stops. ${pick(rng, EMOTIONAL_BEATS.worried)}. He looks around for help.`);
  beats.push(`Scene 5: ${helper} (${state.helperRole}) enters the frame, moving with purpose.`);

  // 6-10: Helper & Interaction
  beats.push(`Scene 6: ${helper} stops beside ${hero}. They share a silent look of understanding.`);
  beats.push(`Scene 7: ${helper} walks to the ${obj} and ${roleData.approach}.`);
  beats.push(`Scene 8: ${helper} brings over the ${state.vehicleDNA}. It rolls with realistic weight.`);
  beats.push(`Scene 9: ${helper} produces the ${state.toolDNA}. It glints in the ${state.weather}.`);
  beats.push(`Scene 10: Willy watches, ${pick(rng, EMOTIONAL_BEATS.hopeful)}. He sits back to give the helper space.`);

  // 11-15: Climax & Resolution
  beats.push(`Scene 11: Attempt 1: ${helper} uses the tool to ${roleData.action}. It budges but isn't fixed yet.`);
  beats.push(`Scene 12: Pivot: ${helper} shifts his weight and tries again with more precision.`);
  beats.push(`Scene 13: Success! The ${state.problem} is resolved. The physics of the object settle into place.`);
  beats.push(`Scene 14: CELEBRATION: ${hero} reacts with ${pick(rng, EMOTIONAL_BEATS.joyous)}. He nudges the helper's shoulder.`);
  beats.push(`Scene 15: Calm closing. ${hero} and ${helper} stay together in the ${state.location}. A job well done.`);

  const out = beats.map((b, i) => `Scene ${i+1}: ${b}`);
  return out;
}

/* --- UI WIRING & BRIDGE --- */
function initUI(){
  const fill = (id, arr) => {
    const el = document.getElementById(id);
    arr.forEach(a => { let o = document.createElement("option"); o.text = a; el.add(o); });
  };
  fill("storyType", STORY_TYPES);
  fill("friends", FRIENDS_OPTIONS);
  fill("problem", BASE_PROBLEMS);
  fill("helperRole", Object.keys(ROLE_ACTIONS));
  fill("helperAnimal", HELPER_ANIMALS_BASE);
  fill("weather", WEATHER);
  fill("location", LOCATIONS);
  fill("objectAffection", OBJECTS_BASE);

  document.getElementById("btn15").onclick = () => createStory(15);
  
  document.getElementById("btnGoToCompiler").onclick = () => {
    const story = document.getElementById("out").textContent;
    localStorage.setItem("pendingStory", story);
    window.location.href = "compiler.html";
  };
}

function createStory(n){
  const seedIn = document.getElementById("seed");
  const rng = mulberry32(xmur3(seedIn.value)());
  
  const state = {
    location: document.getElementById("location").value,
    weather: document.getElementById("weather").value,
    problem: document.getElementById("problem").value,
    helperRole: document.getElementById("helperRole").value,
    helperAnimal: document.getElementById("helperAnimal").value,
    object: document.getElementById("objectAffection").value,
    useObject: document.getElementById("useObject").checked,
    toolDNA: "mini professional tool",
    vehicleDNA: "heavy-duty helper wagon"
  };

  const scenes = buildSceneArc(state, n, rng);
  document.getElementById("out").textContent = `STORY DNA\n---\n${scenes.join("\n")}`;
  seedIn.value = "willy-" + Math.floor(rng() * 1000);
}

initUI();
</script>
</body>
</html>
