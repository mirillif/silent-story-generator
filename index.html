<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>WILLY V2 — Story Generator (Triads + Validator)</title>
  <style>
    :root { --r: 14px; }
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      margin:0; background:#0b0d12; color:#eef2ff; line-height:1.35;
    }
    header{
      padding:20px 18px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(1200px 600px at 18% 0%, rgba(99,102,241,0.22), transparent 62%),
        radial-gradient(900px 450px at 82% 0%, rgba(16,185,129,0.18), transparent 55%);
    }
    header h1{margin:0 0 6px;font-size:20px}
    header p{margin:0;opacity:.85;max-width:1100px}
    a{color:#a5b4fc;text-decoration:none} a:hover{text-decoration:underline}
    main{max-width:1250px;margin:0 auto;padding:18px;display:grid;gap:16px}
    .grid{display:grid;gap:16px;grid-template-columns:1fr}
    @media(min-width:980px){ .grid{grid-template-columns:520px 1fr} }
    .card{
      background:rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius:var(--r);
      padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{margin:0 0 10px;font-size:15px;opacity:.95}
    label{font-size:12px;opacity:.85;display:block;margin-bottom:6px}
    input,select,textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      color:#eef2ff;
      outline:none;
      box-sizing:border-box;
    }
    textarea{min-height:140px;resize:vertical;white-space:pre-wrap}
    .row{display:grid;gap:10px;grid-template-columns:1fr}
    @media(min-width:520px){ .row.two{grid-template-columns:1fr 1fr} }
    .chips{display:flex;flex-wrap:wrap;gap:10px;margin-top:8px}
    .chip{
      display:flex;gap:8px;align-items:center;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
    }
    .chip input{width:auto}
    .btnbar{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:#eef2ff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:900;
    }
    button.primary{background:rgba(99,102,241,.22);border-color:rgba(99,102,241,.45)}
    button.good{background:rgba(16,185,129,.18);border-color:rgba(16,185,129,.40)}
    button.warn{background:rgba(245,158,11,.16);border-color:rgba(245,158,11,.35)}
    button:hover{filter:brightness(1.08)}
    .pill{
      display:inline-flex;gap:8px;align-items:center;
      padding:7px 10px;border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(255,255,255,.05);font-size:12px
    }
    .pill b{font-weight:900}
    .muted{opacity:.78;font-size:12px}
    .out{
      white-space:pre-wrap;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:12px;
      overflow:auto;
      min-height:420px;
      font-size:13px;
    }
    .hr{height:1px;background:rgba(255,255,255,.10);margin:14px 0}
    .k{color:#a5b4fc;font-weight:900}
    .warnbox{
      margin-top:10px;
      border:1px solid rgba(245,158,11,.35);
      background:rgba(245,158,11,.12);
      padding:10px;border-radius:12px;
      font-size:12px;opacity:.95;
      display:none;
      white-space:pre-wrap;
    }
  </style>
</head>
<body>
<header>
  <h1>WILLY V2 — Story Generator (Triads + Validator)</h1>
  <p>
    This generator is <span class="k">meaning-aware</span>: it locks Problem ↔ Object ↔ Role using triads and rejects incoherent combos automatically.
    <br>
    Output is ready to paste into the <a href="./compiler.html">Prompt Compiler →</a>
  </p>
</header>

<main class="grid">
  <section class="card">
    <h2>Controls</h2>

    <div class="row two">
      <div>
        <label>Seed (deterministic)</label>
        <input id="seed" value="willy-v2" placeholder="e.g., 2026-02-06-willy"/>
        <div class="muted" style="margin-top:6px;">Same seed + same settings = same story.</div>
      </div>
      <div>
        <label>Story Type (Engine)</label>
        <select id="engine">
          <option value="AUTO" selected>Auto (best fit)</option>
          <option value="EMOTIONAL_BUILD">Emotional — build/repair/gift (Daddy-cat vibe)</option>
          <option value="RESCUE_ATTEMPTS">Rescue — attempts + tool switch (Fireman-cat vibe)</option>
          <option value="ADVENTURE_ROUTE">Adventure — route obstacles + vehicles</option>
          <option value="FRIENDSHIP_SHARE">Friendship — share/fairness/teamwork</option>
          <option value="FUNNY_SAFE">Funny — safe mishap gets worse once then fixed</option>
          <option value="COURAGE_STEP">Brave — hesitation → micro-steps → success</option>
        </select>
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>Scenes</label>
        <select id="sceneCount">
          <option value="15" selected>15</option>
          <option value="20">20</option>
          <option value="25">25</option>
        </select>
      </div>
      <div>
        <label>Intensity</label>
        <select id="intensity">
          <option value="SOFT">Soft</option>
          <option value="MEDIUM" selected>Medium</option>
          <option value="HIGH">High</option>
        </select>
      </div>
    </div>

    <div class="hr"></div>

    <h2>Cast</h2>
    <div class="chips">
      <label class="chip"><input type="checkbox" id="usePanby" checked/> Allow Panby (optional)</label>
      <label class="chip"><input type="checkbox" id="useQuok" checked/> Allow Quok (optional)</label>
    </div>
    <div class="muted" style="margin-top:6px;">
      Willy is always the hero. Friends appear automatically when the problem requires it (sharing / teamwork).
    </div>

    <div class="hr"></div>

    <h2>Options</h2>
    <div class="chips">
      <label class="chip"><input type="checkbox" id="wantObject" checked/> Include object of affection</label>
      <label class="chip"><input type="checkbox" id="wantCountry"/> Add country/cultural scenery (optional)</label>
      <label class="chip"><input type="checkbox" id="manual"/> Manual overrides</label>
      <label class="chip"><input type="checkbox" id="debugRejects"/> Debug rejections (why combos failed)</label>
    </div>

    <div class="hr"></div>

    <h2>Manual overrides (optional)</h2>
    <div class="row two">
      <div>
        <label>Problem</label>
        <select id="problemSel" disabled></select>
      </div>
      <div>
        <label>Helper Role</label>
        <select id="roleSel" disabled></select>
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>Helper Animal</label>
        <select id="helperSel" disabled></select>
      </div>
      <div>
        <label>Object of Affection</label>
        <select id="objectSel" disabled></select>
      </div>
    </div>

    <div class="row two" style="margin-top:10px;">
      <div>
        <label>Weather / Time</label>
        <select id="weatherSel" disabled></select>
      </div>
      <div>
        <label>Location</label>
        <select id="locationSel" disabled></select>
      </div>
    </div>

    <div class="btnbar">
      <button class="primary" id="generateBtn">Create Story</button>
      <button class="good" id="copyBtn">Copy</button>
      <button class="warn" id="toCompilerBtn">Send to Compiler →</button>
    </div>

    <div style="margin-top:12px;">
      <span class="pill" id="status"><b>Status:</b> Ready</span>
    </div>

    <div class="warnbox" id="rejectBox"></div>

    <div class="muted" style="margin-top:10px;">
      If you force manual overrides into nonsense, the generator will warn you and suggest fixes.
    </div>
  </section>

  <section class="card">
    <h2>Output — Story Frame</h2>
    <div class="out" id="output"></div>
  </section>
</main>

<script>
/* =========================================================
   RNG (deterministic)
========================================================= */
function hashStringToUint(s){
  let h = 2166136261 >>> 0;
  for (let i=0;i<s.length;i++){ h ^= s.charCodeAt(i); h = Math.imul(h, 16777619); }
  return h >>> 0;
}
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  };
}
function pick(rng, arr){ return arr[Math.floor(rng()*arr.length)]; }
function pickMany(rng, arr, n){
  const a = arr.slice(), out=[];
  for (let i=0;i<n && a.length;i++){
    const idx = Math.floor(rng()*a.length);
    out.push(a.splice(idx,1)[0]);
  }
  return out;
}
function clean(s){ return (s||"").replace(/\s+/g," ").trim(); }
function setStatus(t){ document.getElementById("status").innerHTML = "<b>Status:</b> " + t; }
function showRejects(text){
  const box = document.getElementById("rejectBox");
  if (!text){ box.style.display="none"; box.textContent=""; return; }
  box.style.display="block";
  box.textContent = text;
}

/* =========================================================
   Global channel characters (names for story frame)
========================================================= */
const HERO = "Willy (Baby Golden Retriever)";
const FRIENDS = [
  "Panby (Baby Giant Panda)",
  "Quok (Baby Quokka)"
];

/* =========================================================
   Triads system:
   Triad locks compatible sets: problems ↔ objectTypes ↔ roles ↔ helperAnimals ↔ tools/vehicles.
========================================================= */
const TAGS = {
  PATH:"PATH", RESCUE:"RESCUE", OUTREACH:"OUT_OF_REACH", WATER:"WATER",
  REPAIR:"REPAIR", BUILD:"BUILD", CARE:"CARE", SHARE:"SHARE",
  FUNNY:"FUNNY", COURAGE:"COURAGE", DELIVERY:"DELIVERY", AIR:"AIR"
};

/* ---------- Libraries (big + expandable without huge literal dumps) ---------- */
function makeList(prefix, n){ return Array.from({length:n}).map((_,i)=>`${prefix} #${i+1}`); }

/** Objects with type tags (you can expand these easily) */
const OBJECTS = [
  // Vehicles / transport toys
  {name:"tiny toy fire truck", type:"TOY_VEHICLE"},
  {name:"tiny toy ambulance", type:"TOY_VEHICLE"},
  {name:"tiny toy tow truck", type:"TOY_VEHICLE"},
  {name:"tiny toy delivery van", type:"TOY_VEHICLE"},
  {name:"tiny toy bus", type:"TOY_VEHICLE"},
  {name:"tiny wagon", type:"TOY_VEHICLE"},
  {name:"toy excavator", type:"TOY_VEHICLE"},
  {name:"toy tractor", type:"TOY_VEHICLE"},

  // Air / plane toys
  {name:"small wooden airplane", type:"TOY_PLANE"},
  {name:"toy plane with blue wings", type:"TOY_PLANE"},
  {name:"paper airplane", type:"TOY_PLANE"},
  {name:"toy helicopter", type:"TOY_AIR"},

  // Water toys
  {name:"toy sailboat", type:"TOY_BOAT"},
  {name:"toy boat with blue hull", type:"TOY_BOAT"},

  // Art / craft
  {name:"mini paint palette", type:"ART"},
  {name:"tiny sketchbook", type:"ART"},
  {name:"tiny paintbrush", type:"ART"},
  {name:"mini sticker sheet", type:"ART"},

  // Cloth / cozy
  {name:"little cape", type:"CLOTH"},
  {name:"tiny knitted scarf", type:"CLOTH"},
  {name:"tiny blanket", type:"CLOTH"},
  {name:"mini rain boots", type:"CLOTH"},

  // Emotional keepsakes
  {name:"small heart pillow", type:"KEEPSAKE"},
  {name:"tiny music box", type:"KEEPSAKE"},
  {name:"mini storybook", type:"KEEPSAKE"},
  {name:"small photo frame", type:"KEEPSAKE"},

  // Plush
  ...makeList("tiny plush buddy", 80).map(n=>({name:n, type:"PLUSH"})),

  // Trinkets
  ...makeList("little charm trinket", 60).map(n=>({name:n, type:"KEEPSAKE"}))
];

/** Helper roles with tags (100+ feel, but meaningful core first) */
const ROLES = [
  {name:"Bridge Builder", tags:[TAGS.PATH, TAGS.BUILD]},
  {name:"Park Ranger", tags:[TAGS.PATH, TAGS.CARE]},
  {name:"Tow Truck Driver", tags:[TAGS.PATH, TAGS.DELIVERY]},
  {name:"Carpenter", tags:[TAGS.BUILD, TAGS.REPAIR]},
  {name:"Mechanic", tags:[TAGS.REPAIR, TAGS.DELIVERY]},
  {name:"Toy Maker", tags:[TAGS.BUILD, TAGS.REPAIR, TAGS.CARE]},
  {name:"Model Plane Builder", tags:[TAGS.REPAIR, TAGS.AIR]},
  {name:"Firefighter", tags:[TAGS.RESCUE, TAGS.OUTREACH]},
  {name:"Medic", tags:[TAGS.CARE, TAGS.RESCUE]},
  {name:"Lifeguard", tags:[TAGS.WATER, TAGS.RESCUE]},
  {name:"Boat Captain", tags:[TAGS.WATER, TAGS.DELIVERY]},
  {name:"Knitwear Maker", tags:[TAGS.CARE, "CLOTH_ROLE"]},
  {name:"Tailor", tags:[TAGS.CARE, "CLOTH_ROLE"]},
  {name:"Friendship Mediator", tags:[TAGS.SHARE, TAGS.CARE]},
  {name:"Play Organizer", tags:[TAGS.FUNNY, TAGS.CARE]},
  {name:"Courage Coach", tags:[TAGS.COURAGE, TAGS.CARE]},
  // filler roles with generic tags but still grouped
  ...makeList("Helper Role", 110).map((n,i)=>({
    name:n,
    tags: (i%6===0)?[TAGS.RESCUE] :
          (i%6===1)?[TAGS.REPAIR] :
          (i%6===2)?[TAGS.BUILD] :
          (i%6===3)?[TAGS.CARE] :
          (i%6===4)?[TAGS.PATH] :
                   [TAGS.FUNNY]
  }))
];

/** Helper animals (always animals) */
const HELPERS = [
  {name:"beaver builder helper", tags:[TAGS.BUILD, TAGS.PATH]},
  {name:"cat firefighter helper", tags:[TAGS.RESCUE]},
  {name:"bunny medic helper", tags:[TAGS.CARE, TAGS.RESCUE]},
  {name:"otter lifeguard helper", tags:[TAGS.WATER, TAGS.RESCUE]},
  {name:"red panda mechanic helper", tags:[TAGS.REPAIR]},
  {name:"deer park ranger helper", tags:[TAGS.PATH]},
  {name:"baby duck delivery helper", tags:[TAGS.DELIVERY]},
  {name:"chipmunk carpenter helper", tags:[TAGS.BUILD]},
  {name:"penguin snow guide helper", tags:[TAGS.COURAGE]},
  ...makeList("cute helper animal", 90).map((n,i)=>({
    name:n,
    tags: (i%7===0)?[TAGS.BUILD] :
          (i%7===1)?[TAGS.RESCUE] :
          (i%7===2)?[TAGS.CARE] :
          (i%7===3)?[TAGS.REPAIR] :
          (i%7===4)?[TAGS.PATH] :
          (i%7===5)?[TAGS.DELIVERY] :
                   [TAGS.FUNNY]
  }))
];

/** Weather/time (30+) */
const WEATHER = [
  {t:"Spring morning, soft sunlight, mild breeze", tags:["MILD","GREEN"]},
  {t:"Warm summer afternoon, bright sun, clear sky", tags:["WARM","SUNNY"]},
  {t:"Overcast day, gentle cool light", tags:["COOL","CLOUDY"]},
  {t:"Light rain, puddles forming, soft grey sky", tags:["RAIN","MILD"]},
  {t:"Heavy rain, visible raindrops, bigger puddles", tags:["RAIN","HEAVY"]},
  {t:"Thunderstorm, dark clouds, distant lightning (safe)", tags:["STORM"]},
  {t:"Cold winter morning, pale sun, frosty air", tags:["COLD","FROST"]},
  {t:"Snowy day, soft snowfall, quiet atmosphere", tags:["SNOW","COLD"]},
  {t:"Golden hour evening, warm low sun, long shadows", tags:["WARM","SOFT"]},
  {t:"Early morning mist, soft haze, calm air", tags:["MIST","COOL"]},
  ...makeList("Weather Variant", 20).map((n,i)=>({
    t:n,
    tags:(i%5===0)?["RAIN"]:(i%5===1)?["MILD"]:(i%5===2)?["WARM"]:(i%5===3)?["COOL"]:["WIND"]
  }))
];

/** Locations (neutral + country-flavor optional) */
const LOCATIONS = [
  {t:"Park meadow — soft grass, big tree, distant hills", tags:["GREEN","MILD"], country:null},
  {t:"Neutral garden path — trimmed bushes, warm stone walkway", tags:["PATH","MILD"], country:null},
  {t:"Riverside path — smooth stones, gentle water, reeds", tags:["PATH","WATER","MILD"], country:null},
  {t:"Cozy workshop — wooden table, neat tools, warm daylight", tags:["INDOOR","TOOLS","COZY"], country:null},
  {t:"Autumn forest trail — fallen leaves, earthy tones", tags:["PATH","FOREST","COOL"], country:null},
  {t:"Snowy forest clearing — pine trees, fresh snow", tags:["SNOW","COLD","FOREST"], country:null},
  {t:"Mountain meadow — rocky ground, distant peaks, crisp light", tags:["COOL","ROCKY"], country:null},
  // cultural options
  {t:"Japan — wooden house corridor, shoji screens, tatami floor, calm courtyard view", tags:["INDOOR","COZY"], country:"Japan"},
  {t:"France — stone village lane, shutters, small bakery shapes (no text)", tags:["CITY","MILD"], country:"France"},
  {t:"Taiwan — narrow street with scooter silhouettes (no logos), humid warm light", tags:["CITY","WARM"], country:"Taiwan"},
  ...makeList("Neutral Scenic Location", 60).map((n,i)=>({t:n, tags:(i%4===0)?["MILD"]: (i%4===1)?["PATH"]: (i%4===2)?["COOL"]:["COZY"], country:null}))
];

/** Problems (50+ real + expandable) */
const PROBLEMS = [
  // RESCUE style
  {t:"Cherished toy is stuck in a tree", tags:[TAGS.RESCUE, TAGS.OUTREACH], requiresFriends:false},
  {t:"Object is out of reach on a ledge", tags:[TAGS.RESCUE, TAGS.OUTREACH], requiresFriends:false},
  {t:"A little balloon drifts upward and gets snagged", tags:[TAGS.RESCUE, TAGS.OUTREACH], requiresFriends:false},

  // REPAIR / Emotional build
  {t:"Favorite toy is broken and can’t be used", tags:[TAGS.REPAIR, TAGS.CARE], requiresFriends:false},
  {t:"A toy plane propeller is bent", tags:[TAGS.REPAIR, TAGS.AIR], requiresFriends:false},
  {t:"A cherished keepsake is scratched and needs fixing", tags:[TAGS.REPAIR, TAGS.CARE], requiresFriends:false},

  // PATH / Adventure
  {t:"A path is blocked by fallen branches", tags:[TAGS.PATH, TAGS.BUILD], requiresFriends:false},
  {t:"A wagon is stuck in mud", tags:[TAGS.PATH, TAGS.BUILD], requiresFriends:false},
  {t:"A puddle is too wide to cross safely", tags:[TAGS.PATH, TAGS.BUILD], requiresFriends:false},

  // WATER
  {t:"A small toy boat drifts away from shore", tags:[TAGS.WATER, TAGS.RESCUE], requiresFriends:false},

  // FRIENDSHIP
  {t:"Two friends want the same toy and must share", tags:[TAGS.SHARE, TAGS.CARE], requiresFriends:true},
  {t:"A friend feels left out during play", tags:[TAGS.SHARE, TAGS.CARE], requiresFriends:true},

  // FUNNY
  {t:"A hat keeps slipping over the eyes", tags:[TAGS.FUNNY], requiresFriends:false},
  {t:"A stack of cups wobbles and tips in a silly way", tags:[TAGS.FUNNY], requiresFriends:false},

  // COURAGE
  {t:"Thunder scares the hero and a brave step is needed", tags:[TAGS.COURAGE, TAGS.CARE], requiresFriends:false},
  {t:"A narrow step looks scary to cross", tags:[TAGS.COURAGE, TAGS.PATH], requiresFriends:false},

  // Expand quickly to reach “many options”
  ...makeList("Problem Variant", 55).map((n,i)=>({
    t:n,
    tags:(i%6===0)?[TAGS.RESCUE]:(i%6===1)?[TAGS.REPAIR]:(i%6===2)?[TAGS.PATH]:(i%6===3)?[TAGS.SHARE]:(i%6===4)?[TAGS.FUNNY]:[TAGS.COURAGE],
    requiresFriends:(i%11===0)
  }))
];

/* ---------- Tools + vehicles with explicit DNA text ---------- */
const TOOL_LIBRARY = [
  {name:"tiny extendable ladder, 22cm toy-scale, red aluminum, silver hinges", tags:[TAGS.RESCUE, TAGS.OUTREACH]},
  {name:"small rescue net, 18cm hoop, white mesh, blue handle", tags:[TAGS.RESCUE, TAGS.OUTREACH]},
  {name:"mini rope spool, 2m twine, tan color, wooden spool", tags:[TAGS.RESCUE, TAGS.PATH]},
  {name:"small wood plank, 25cm, light pine, smooth edges", tags:[TAGS.PATH, TAGS.BUILD]},
  {name:"mini hammer, 8cm, wooden handle", tags:[TAGS.BUILD]},
  {name:"tiny screwdriver set, 6cm handles, matte yellow plastic", tags:[TAGS.REPAIR]},
  {name:"mini wrench, 7cm, brushed steel", tags:[TAGS.REPAIR]},
  {name:"soft pastel yarn ball + 8cm bamboo needles", tags:["CLOTH_ROLE", TAGS.CARE]},
  {name:"tiny sewing kit, thread spools + blunt needle, pastel case", tags:["CLOTH_ROLE", TAGS.CARE]},
  {name:"two tiny traffic cones, 6cm, bright orange matte plastic", tags:[TAGS.PATH]},
  {name:"mini first-aid pouch, 10cm, red with white cross symbol (no text)", tags:[TAGS.CARE, TAGS.RESCUE]}
];

const VEHICLE_LIBRARY = [
  {name:"toy fire truck, 28cm, glossy red plastic, silver ladder", tags:[TAGS.RESCUE]},
  {name:"toy ambulance, 28cm, glossy white plastic, red stripe (no text)", tags:[TAGS.RESCUE, TAGS.CARE]},
  {name:"toy tow truck, 26cm, yellow plastic, black hook", tags:[TAGS.PATH]},
  {name:"toy delivery scooter, 20cm, yellow body, white basket", tags:[TAGS.DELIVERY]},
  {name:"mini wheelbarrow, 24cm, green metal basin, black wheel", tags:[TAGS.BUILD]},
  {name:"toy boat, 24cm, blue hull, white deck", tags:[TAGS.WATER]}
];

/* =========================================================
   TRIADS (the lock)
========================================================= */
const TRIADS = [
  {
    key:"RESCUE_ATTEMPTS",
    label:"Rescue attempts",
    problemTags:[TAGS.RESCUE, TAGS.OUTREACH, TAGS.WATER],
    objectTypes:["PLUSH","KEEPSAKE","TOY_PLANE","TOY_AIR","TOY_BOAT","NATURE"],
    roleTags:[TAGS.RESCUE, TAGS.OUTREACH, TAGS.CARE, TAGS.WATER],
    helperTags:[TAGS.RESCUE, TAGS.CARE, TAGS.WATER],
    requiredFeatures:{attempts:true, toolSwitch:true, objectTransforms:true}
  },
  {
    key:"EMOTIONAL_BUILD",
    label:"Emotional build/repair",
    problemTags:[TAGS.REPAIR, TAGS.CARE, TAGS.AIR],
    objectTypes:["TOY_PLANE","TOY_VEHICLE","PLUSH","KEEPSAKE","ART","CLOTH"],
    roleTags:[TAGS.REPAIR, TAGS.BUILD, TAGS.CARE, "CLOTH_ROLE", TAGS.AIR],
    helperTags:[TAGS.CARE, TAGS.REPAIR, TAGS.BUILD],
    requiredFeatures:{attempts:false, toolSwitch:false, objectTransforms:true}
  },
  {
    key:"ADVENTURE_ROUTE",
    label:"Adventure route",
    problemTags:[TAGS.PATH, TAGS.BUILD, TAGS.DELIVERY],
    objectTypes:["TOY_VEHICLE","FOOD","KEEPSAKE","PLUSH"],
    roleTags:[TAGS.PATH, TAGS.BUILD, TAGS.DELIVERY],
    helperTags:[TAGS.PATH, TAGS.BUILD, TAGS.DELIVERY],
    requiredFeatures:{attempts:true, toolSwitch:false, objectTransforms:true}
  },
  {
    key:"FRIENDSHIP_SHARE",
    label:"Friendship share",
    problemTags:[TAGS.SHARE, TAGS.CARE],
    objectTypes:["TOY_VEHICLE","PLUSH","ART","KEEPSAKE"],
    roleTags:[TAGS.CARE, TAGS.BUILD, TAGS.REPAIR, TAGS.SHARE],
    helperTags:[TAGS.CARE],
    requiredFeatures:{attempts:false, toolSwitch:false, objectTransforms:true, needsFriends:true}
  },
  {
    key:"FUNNY_SAFE",
    label:"Funny safe mishap",
    problemTags:[TAGS.FUNNY],
    objectTypes:["PLUSH","ART","KEEPSAKE","TOY_VEHICLE","CLOTH"],
    roleTags:[TAGS.FUNNY, TAGS.CARE, TAGS.BUILD],
    helperTags:[TAGS.FUNNY, TAGS.CARE],
    requiredFeatures:{attempts:true, toolSwitch:false, objectTransforms:true, getsWorseOnce:true}
  },
  {
    key:"COURAGE_STEP",
    label:"Courage micro-steps",
    problemTags:[TAGS.COURAGE, TAGS.PATH, TAGS.CARE],
    objectTypes:["KEEPSAKE","PLUSH","TOY_VEHICLE","CLOTH"],
    roleTags:[TAGS.COURAGE, TAGS.CARE, TAGS.PATH],
    helperTags:[TAGS.CARE, TAGS.COURAGE, TAGS.PATH],
    requiredFeatures:{attempts:true, toolSwitch:false, objectTransforms:true}
  }
];

/* =========================================================
   Role-specific action micro-library (THIS makes scenes exciting)
========================================================= */
const ROLE_ACTIONS = [
  {
    match:(role)=>/Firefighter|Rescue|Medic|Lifeguard/i.test(role),
    verbs:{
      tool:"sets down the tool carefully",
      attempt1:"tries the first safe reach and it does not work yet",
      attempt2:"changes the angle and tries again with clearer progress",
      upgrade:"adds a stabilizer detail (rope/board/brace)",
      success:"secures the item safely without any sudden jerks"
    }
  },
  {
    match:(role)=>/Bridge Builder|Carpenter|Builder|Ranger/i.test(role),
    verbs:{
      tool:"lays the plank/board flat with a firm push",
      attempt1:"tries to move the obstacle once and it shifts but blocks again",
      attempt2:"repositions and lever-lifts the branch with controlled force",
      upgrade:"adds cones/markers and a second plank for stability",
      success:"clears a clean safe passage with visible space to walk"
    }
  },
  {
    match:(role)=>/Mechanic|Toy Maker|Plane Builder/i.test(role),
    verbs:{
      tool:"places tools in a neat row before touching the object",
      attempt1:"tightens/aligns one piece and it still wobbles",
      attempt2:"adds a second fix that stabilizes the part",
      upgrade:"polishes/paints a cute finishing detail",
      success:"tests gently and the object works smoothly"
    }
  },
  {
    match:(role)=>/Knitwear|Tailor/i.test(role),
    verbs:{
      tool:"unrolls yarn and taps the needles together once",
      attempt1:"knits a tiny looped strap and it is too short",
      attempt2:"adds extra rows to lengthen and soften the strap",
      upgrade:"stitches a tiny bow or padding for comfort",
      success:"wraps/straps the soft knit solution so it holds securely"
    }
  },
  {
    match:(role)=>/Mediator|Friendship|Coach/i.test(role),
    verbs:{
      tool:"points with the nose/paw to show positions (no rushing)",
      attempt1:"tries a simple fairness gesture and it’s not enough",
      attempt2:"creates a clear sharing setup that both can access",
      upgrade:"adds a cute rule object (two markers) to keep it fair",
      success:"both friends get equal access and relax visibly"
    }
  },
  // fallback
  {
    match:()=>true,
    verbs:{
      tool:"brings a helpful tool into view",
      attempt1:"tries once and it doesn’t work yet",
      attempt2:"adjusts and tries again with progress",
      upgrade:"adds one small stabilizing detail",
      success:"finishes safely and clearly"
    }
  }
];
function verbsForRole(roleName){
  return ROLE_ACTIONS.find(r=>r.match(roleName)).verbs;
}

/* =========================================================
   Validator (the gatekeeper)
========================================================= */
function hasAnyTag(itemTags, neededTags){
  const s = new Set(itemTags||[]);
  return (neededTags||[]).some(t=>s.has(t));
}
function locCompatible(weatherTags, locTags){
  const w = new Set(weatherTags||[]);
  const l = new Set(locTags||[]);
  // simple logic (extend anytime)
  if (w.has("SNOW") && (l.has("WARM") || l.has("WATER"))) return false;
  if (w.has("COLD") && l.has("WARM")) return false;
  return true;
}

function validateCombo(triad, problem, object, role, helper, friends, weather, location){
  const reasons = [];

  // triad tag match
  if (!hasAnyTag(problem.tags, triad.problemTags)) reasons.push("Problem does not match triad tags.");
  if (object && !triad.objectTypes.includes(object.type)) reasons.push(`Object type '${object.type}' not allowed for triad.`);
  if (!hasAnyTag(role.tags, triad.roleTags)) reasons.push("Role does not match triad role tags.");
  if (!hasAnyTag(helper.tags, triad.helperTags)) reasons.push("Helper animal does not match triad helper tags.");

  // friends requirement
  if (triad.requiredFeatures.needsFriends || problem.requiresFriends){
    if (!friends || friends.length < 1) reasons.push("This story needs at least one friend, but none were included.");
  }

  // weather/location compatibility
  if (!locCompatible(weather.tags, location.tags)) reasons.push("Weather and location are incompatible.");

  // special rule: Cloth roles must not be assigned to path-clearing problems unless object is cloth and solution is cloth-based
  if ((/Knitwear|Tailor/i.test(role.name)) && problem.tags.includes(TAGS.PATH) && (!object || object.type !== "CLOTH")){
    reasons.push("Cloth role + path obstacle requires CLOTH object (otherwise incoherent).");
  }

  // object transformation requirement
  if (triad.requiredFeatures.objectTransforms && !object){
    // allowed for some stories, but in this channel you usually want an object if checked.
    // We'll treat this as a soft warning only if wantObject was on; handled elsewhere.
  }

  return {ok: reasons.length === 0, reasons};
}

/* =========================================================
   Picker helpers (respect triads)
========================================================= */
function pickFrom(rng, arr, predicate){
  const cand = predicate ? arr.filter(predicate) : arr.slice();
  return cand.length ? pick(rng, cand) : pick(rng, arr);
}

function pickTriad(rng, engineKey){
  if (engineKey && engineKey !== "AUTO") return TRIADS.find(t=>t.key===engineKey) || pick(rng, TRIADS);
  // weighted auto
  const pool = [];
  TRIADS.forEach(t => { for (let i=0;i<3;i++) pool.push(t); });
  // bias a little random
  for (let i=0;i<6;i++) pool.push(pick(rng, TRIADS));
  return pick(rng, pool);
}

function pickProblem(rng, triad){
  return pickFrom(rng, PROBLEMS, p=>hasAnyTag(p.tags, triad.problemTags));
}

function pickObject(rng, triad, wantObject){
  if (!wantObject) return null;
  return pickFrom(rng, OBJECTS, o=>triad.objectTypes.includes(o.type));
}

function pickRole(rng, triad, problem, object){
  // must match triad.roleTags and also problem tags (stronger) and object type constraints
  const mustTags = new Set([...(triad.roleTags||[]), ...(problem.tags||[])]);
  return pickFrom(rng, ROLES, r=>{
    const matchTriad = hasAnyTag(r.tags, triad.roleTags);
    const matchProb = hasAnyTag(r.tags, problem.tags) || hasAnyTag(problem.tags, r.tags);
    if (!matchTriad) return false;
    // object constraints
    if (object){
      if (object.type==="CLOTH" && !r.tags.includes("CLOTH_ROLE") && !r.tags.includes(TAGS.CARE)) return false;
      if (object.type==="TOY_PLANE" && !(r.tags.includes(TAGS.AIR) || /plane|pilot|air/i.test(r.name) || r.tags.includes(TAGS.REPAIR))) return false;
      if (object.type==="TOY_BOAT" && !(r.tags.includes(TAGS.WATER) || r.tags.includes(TAGS.RESCUE))) return false;
    }
    // for PATH, prefer PATH/BUILD/DELIVERY
    if (problem.tags.includes(TAGS.PATH) && !(r.tags.includes(TAGS.PATH) || r.tags.includes(TAGS.BUILD) || r.tags.includes(TAGS.DELIVERY))) return false;
    return matchProb || true;
  });
}

function pickHelper(rng, triad, role){
  return pickFrom(rng, HELPERS, h => hasAnyTag(h.tags, triad.helperTags) && (hasAnyTag(h.tags, role.tags) || hasAnyTag(role.tags, h.tags)));
}

function pickTool(rng, triad, role, problem){
  const tags = Array.from(new Set([...(role.tags||[]), ...(problem.tags||[]), ...(triad.problemTags||[])]));
  return pickFrom(rng, TOOL_LIBRARY, t=>hasAnyTag(t.tags, tags));
}

function pickVehicle(rng, triad, role, problem){
  const tags = Array.from(new Set([...(role.tags||[]), ...(problem.tags||[]), ...(triad.problemTags||[])]));
  // optional vehicle
  const candidates = VEHICLE_LIBRARY.filter(v=>hasAnyTag(v.tags, tags));
  if (!candidates.length) return null;
  return (rng() < 0.75) ? pick(rng, candidates) : null;
}

function pickWeather(rng){ return pick(rng, WEATHER); }
function pickLocation(rng, weather, wantCountry){
  const pool = LOCATIONS.filter(l => wantCountry ? true : !l.country);
  const cand = pool.filter(l => locCompatible(weather.tags, l.tags));
  return cand.length ? pick(rng, cand) : pick(rng, pool);
}

/* =========================================================
   Story title generator (must match helper/role/problem)
========================================================= */
function buildTitle(rng, heroName, triad, helperName, roleName, problemText, objectName){
  const patterns = [
    `${heroName.split(" (")[0]} and the ${helperName.replace(" helper","")}`,
    `${heroName.split(" (")[0]} and the ${roleName}`,
    `${heroName.split(" (")[0]} and the Little Problem That Became a Big Smile`,
    `${heroName.split(" (")[0]} and the Brave Small Step`,
    `${heroName.split(" (")[0]} and the Helping Friend`
  ];
  const base = pick(rng, patterns);
  const tail = objectName ? ` — ${problemText}` : ` — ${problemText}`;
  return clean(base + tail);
}

/* =========================================================
   Scene engine templates (triad-specific, with action logic)
========================================================= */
function buildBeats(triad, sceneCount, intensity, ctx){
  const v = verbsForRole(ctx.role);

  // Core beats per triad (15 base)
  const engines = {
    EMOTIONAL_BUILD: [
      `Calm opening in ${ctx.location}. ${ctx.hero} is still, tiny blep visible.`,
      `${ctx.hero} is close to ${ctx.objectName}, under ${ctx.weather}.`,
      `Problem becomes clear: ${ctx.problem}. ${ctx.hero} stops and looks down.`,
      `${ctx.hero} stays very still beside ${ctx.objectName}, body small and quiet.`,
      `${ctx.helper} notices and approaches slowly, watching ${ctx.hero}.`,
      `${ctx.helper} sits close in a comforting way. Both look at ${ctx.objectName} (not camera).`,
      `${ctx.helper} turns toward the workspace and moves with purpose (one motion).`,
      `${ctx.helper} ${v.tool} — ${ctx.toolName} becomes clearly visible.`,
      `${ctx.helper} begins the fix: one careful step using ${ctx.toolName} (one action).`,
      `${ctx.helper} continues the fix: visible progress on ${ctx.objectName} (one action).`,
      `${ctx.helper} adds a cute finishing detail to make it extra safe (one action).`,
      `${ctx.helper} tests gently — it works smoothly (one action).`,
      `${ctx.helper} reveals the improved ${ctx.objectName} to ${ctx.hero}.`,
      `${ctx.hero} moves closer slowly, tail wagging softly; relief is physical.`,
      `Calm closing echo in ${ctx.location} under ${ctx.weather}.`
    ],
    RESCUE_ATTEMPTS: [
      `Calm opening in ${ctx.location}. ${ctx.hero} scans the area slowly.`,
      `${ctx.hero} spots ${ctx.objectName} connected to the situation and steps closer.`,
      `Cause: ${ctx.hero} makes one small attempt (one motion).`,
      `Effect: ${ctx.problem} is clearly visible with realistic gravity.`,
      `${ctx.hero} freezes and looks around for help, ears tilting back slightly.`,
      `${ctx.helper} arrives with purpose${ctx.vehicleName?`, ${ctx.vehicleName} visible behind them`:``}.`,
      `${ctx.helper} ${v.tool} — ${ctx.toolName} is placed carefully (one action).`,
      `Attempt 1: ${ctx.helper} ${v.attempt1} (one action).`,
      `Reaction: ${ctx.helper} pauses, stares at the setup, then repositions (still/slow).`,
      `Attempt 2: ${ctx.helper} ${v.attempt2} (one action).`,
      `Cause→effect: progress is visible, but not enough yet.`,
      `Tool switch or upgrade: ${ctx.helper} ${v.upgrade} (one action).`,
      `Final attempt: ${ctx.helper} ${v.success} (one action).`,
      `Success: ${ctx.objectName} is safe; the problem is resolved clearly.`,
      `Calm closing echo with ${ctx.hero} relaxed near ${ctx.helper} in ${ctx.location}.`
    ],
    ADVENTURE_ROUTE: [
      `Calm opening in ${ctx.location}. ${ctx.hero} stands near ${ctx.objectName} like a mission item.`,
      `${ctx.hero} looks toward the route, then back at ${ctx.objectName}, showing purpose.`,
      `Cause: ${ctx.hero} starts moving along the path (one motion).`,
      `Effect: ${ctx.problem} blocks the route clearly.`,
      `${ctx.helper} appears and gestures toward transport${ctx.vehicleName?` — ${ctx.vehicleName}`:``}.`,
      `${ctx.helper} sets up transport and secures ${ctx.objectName} safely (one action).`,
      `Movement shot: ${ctx.helper} leads; ${ctx.hero} follows; camera stable.`,
      `Attempt 1: ${ctx.helper} ${v.attempt1} to clear the path (one action).`,
      `Reaction: ${ctx.helper} stops, reassesses, and repositions (still/slow).`,
      `Attempt 2: ${ctx.helper} ${v.attempt2} (one action).`,
      `Progress: the route opens partially, but needs one more detail.`,
      `Upgrade: ${ctx.helper} ${v.upgrade} (one action).`,
      `Success: ${ctx.helper} ${v.success} — passage is clear.`,
      `Near destination: ${ctx.hero} sees the goal area and speeds up slightly.`,
      `Calm closing echo in ${ctx.location} under ${ctx.weather}.`
    ],
    FRIENDSHIP_SHARE: [
      `Calm opening in ${ctx.location}. ${ctx.hero} is present under ${ctx.weather}.`,
      `${ctx.friendName} appears and looks at ${ctx.hero}, then at ${ctx.objectName}.`,
      `Problem becomes clear: ${ctx.problem}. Both stop and stare at the same item.`,
      `Cause: ${ctx.hero} makes one small move toward ${ctx.objectName} (one motion).`,
      `Effect: tension shows physically; both pause (still/slow).`,
      `${ctx.helper} arrives calmly and watches for a beat, then steps in.`,
      `${ctx.helper} ${v.tool} — ${ctx.toolName} becomes visible.`,
      `Attempt: ${ctx.helper} ${v.attempt1} to make it fair (one action).`,
      `Reaction: both friends stare; it’s not fully fair yet.`,
      `Second attempt: ${ctx.helper} ${v.attempt2} (one action).`,
      `Upgrade: ${ctx.helper} ${v.upgrade} (one action).`,
      `Success: ${ctx.helper} ${v.success} — sharing is clearly possible.`,
      `${ctx.hero} and ${ctx.friendName} relax; tails/bodies soften (still/slow).`,
      `${ctx.hero} and ${ctx.friendName} use the fair setup gently (one motion).`,
      `Calm closing echo in ${ctx.location}.`
    ],
    FUNNY_SAFE: [
      `Calm opening in ${ctx.location}. ${ctx.hero} spots ${ctx.objectName}; tiny blep visible.`,
      `${ctx.hero} gives ${ctx.objectName} one playful nudge (one motion).`,
      `Cause: ${ctx.problem} begins as a small harmless mishap.`,
      `Effect: the mishap becomes sillier but safe, with believable physics.`,
      `${ctx.hero} freezes in a funny posture, ears perked unevenly.`,
      `${ctx.helper} arrives, watches one beat, then moves in.`,
      `${ctx.helper} ${v.tool} — ${ctx.toolName} is placed down (one action).`,
      `Attempt 1: ${ctx.helper} ${v.attempt1} — it gets slightly worse once (cute).`,
      `Pause: both stare at the result (still/slow).`,
      `Attempt 2: ${ctx.helper} ${v.attempt2} (one action).`,
      `Upgrade: ${ctx.helper} ${v.upgrade} (one action).`,
      `Success: ${ctx.helper} ${v.success} — the silly problem resolves cleanly.`,
      `${ctx.hero} does one small happy bounce (one motion).`,
      `Calm closing echo in ${ctx.location} under ${ctx.weather}.`,
      `Extra cute beat: ${ctx.hero} gently taps ${ctx.objectName} once, now safely.`
    ],
    COURAGE_STEP: [
      `Calm opening in ${ctx.location}. ${ctx.hero} approaches slowly under ${ctx.weather}.`,
      `${ctx.hero} sees the challenge inside ${ctx.problem} and stops.`,
      `Body language: ears dip, breathing visible; ${ctx.hero} holds still.`,
      `${ctx.helper} arrives quietly and stands beside ${ctx.hero}, not rushing.`,
      `${ctx.helper} ${v.tool} — ${ctx.toolName} is shown clearly (one action).`,
      `Micro-step 1: ${ctx.helper} demonstrates a safe tiny step (one action).`,
      `Micro-step 2: ${ctx.hero} copies carefully (one action).`,
      `Cause: a second micro-step is attempted (one action).`,
      `Effect: progress is visible but the challenge remains.`,
      `Upgrade: ${ctx.helper} ${v.upgrade} (one action).`,
      `Brave step: ${ctx.hero} takes the step (one action), then pauses to breathe.`,
      `Relief beat: posture relaxes; tail moves gently.`,
      `Success: ${ctx.helper} ${v.success} — safe outcome is clear.`,
      `${ctx.hero} shows proud joy physically (soft eyes, calm tail wag, blep).`,
      `Calm closing echo in ${ctx.location}.`
    ]
  };

  // choose base list
  let beats = (engines[triad.key] || engines.EMOTIONAL_BUILD).slice();

  // Expand to 20/25 by inserting extra concrete progress beats
  if (sceneCount > beats.length){
    const extra = [
      `${ctx.helper} aligns the setup carefully to keep physics stable (one action).`,
      `${ctx.hero} stays still and watches, eyes tracking ${ctx.toolName}.`,
      `${ctx.helper} makes one neat adjustment, then pauses (still/slow).`,
      ctx.friendName ? `${ctx.friendName} holds still to avoid shaking anything.` : `${ctx.hero} shifts weight slightly, then freezes again.`,
      `${ctx.helper} checks the object’s stability with a tiny gentle push (one action).`
    ];
    const need = sceneCount - beats.length;
    const mid = Math.floor(beats.length/2);
    beats.splice(mid, 0, ...extra.slice(0, need));
  }

  // Intensity tweaks
  if (intensity === "HIGH"){
    beats = beats.map((b,i)=> (i===2 || i===7) ? (b + " Movement is lively but still readable.") : b);
  }
  if (intensity === "SOFT"){
    beats = beats.map(b=>b.replace("gets slightly worse once", "does not work yet"));
  }

  // Trim if needed
  beats = beats.slice(0, sceneCount);
  return beats;
}

/* =========================================================
   Prop DNA (Story anchors for prompt compiler)
========================================================= */
function propDNA(object, tool, vehicle){
  const obj = object
    ? `OBJECT DNA: (${object.name}; type=${object.type}; toy-scale; material: matte plastic/soft fabric depending on item; exact name must be repeated verbatim.)`
    : `OBJECT DNA: (none; focus is the situation/relationship.)`;
  const tl = tool
    ? `TOOL DNA: (${tool.name}; exact name repeated verbatim; realistic weight; used only in still/slow interactions.)`
    : `TOOL DNA: (none)`;
  const vh = vehicle
    ? `VEHICLE DNA: (${vehicle.name}; exact name repeated verbatim; toy-scale; realistic rolling/weight.)`
    : `VEHICLE DNA: (none)`;
  return [obj, tl, vh].join("\n");
}

/* =========================================================
   Manual UI
========================================================= */
function fillSelect(id, arr, labelFn){
  const sel = document.getElementById(id);
  sel.innerHTML = "";
  arr.forEach(x=>{
    const opt = document.createElement("option");
    opt.value = labelFn(x);
    opt.textContent = labelFn(x);
    sel.appendChild(opt);
  });
}
function initUI(){
  fillSelect("problemSel", PROBLEMS, x=>x.t);
  fillSelect("roleSel", ROLES, x=>x.name);
  fillSelect("helperSel", HELPERS, x=>x.name);
  fillSelect("objectSel", OBJECTS.filter(o=>!o.name.includes("#")), x=>x.name);
  fillSelect("weatherSel", WEATHER, x=>x.t);
  fillSelect("locationSel", LOCATIONS, x=>x.t);
}
initUI();

document.getElementById("manual").addEventListener("change",(e)=>{
  const on = e.target.checked;
  ["problemSel","roleSel","helperSel","objectSel","weatherSel","locationSel"].forEach(id=>{
    document.getElementById(id).disabled = !on;
  });
});

/* =========================================================
   Generation main: regenerate until valid
========================================================= */
function generateStory(){
  setStatus("Generating…");
  showRejects("");

  const seed = document.getElementById("seed").value || "willy-v2";
  const engineKey = document.getElementById("engine").value;
  const sceneCount = parseInt(document.getElementById("sceneCount").value, 10);
  const intensity = document.getElementById("intensity").value;

  const wantObject = document.getElementById("wantObject").checked;
  const wantCountry = document.getElementById("wantCountry").checked;
  const manual = document.getElementById("manual").checked;
  const debugRejects = document.getElementById("debugRejects").checked;

  const rng = mulberry32(hashStringToUint(seed + "|" + engineKey + "|" + sceneCount + "|" + intensity));

  const allowPanby = document.getElementById("usePanby").checked;
  const allowQuok = document.getElementById("useQuok").checked;

  const rejectLog = [];
  const MAX_TRIES = 40;

  for (let tries=1; tries<=MAX_TRIES; tries++){
    // choose triad
    const triad = pickTriad(rng, engineKey);

    // pick core elements
    let problem = pickProblem(rng, triad);
    let object = pickObject(rng, triad, wantObject);
    let role = pickRole(rng, triad, problem, object);
    let helper = pickHelper(rng, triad, role);

    // friends logic
    let friends = [];
    if (problem.requiresFriends || triad.requiredFeatures.needsFriends){
      // must have at least one friend
      const pool = [];
      if (allowPanby) pool.push(FRIENDS[0]);
      if (allowQuok) pool.push(FRIENDS[1]);
      if (!pool.length) pool.push(...FRIENDS);
      friends = pickMany(rng, pool, 1);
    } else {
      const pool = [];
      if (allowPanby) pool.push(FRIENDS[0]);
      if (allowQuok) pool.push(FRIENDS[1]);
      if (pool.length && rng()<0.55) friends.push(pick(rng, pool));
      if (pool.length && rng()<0.20 && friends.length<2) friends.push(pick(rng, pool));
      friends = Array.from(new Set(friends));
    }

    // weather + location
    let weather = pickWeather(rng);
    let location = pickLocation(rng, weather, wantCountry);

    // tool + vehicle
    let tool = pickTool(rng, triad, role, problem);
    let vehicle = pickVehicle(rng, triad, role, problem);

    // manual overrides
    if (manual){
      const p = PROBLEMS.find(x=>x.t === document.getElementById("problemSel").value);
      const r = ROLES.find(x=>x.name === document.getElementById("roleSel").value);
      const h = HELPERS.find(x=>x.name === document.getElementById("helperSel").value);
      const o = OBJECTS.find(x=>x.name === document.getElementById("objectSel").value);
      const w = WEATHER.find(x=>x.t === document.getElementById("weatherSel").value);
      const l = LOCATIONS.find(x=>x.t === document.getElementById("locationSel").value);

      if (p) problem = p;
      if (r) role = r;
      if (h) helper = h;
      if (wantObject && o) object = o;
      if (!wantObject) object = null;
      if (w) weather = w;
      if (l) location = l;

      // re-pick tool/vehicle consistent with overrides
      tool = pickTool(rng, triad, role, problem);
      vehicle = pickVehicle(rng, triad, role, problem);
    }

    // validate combo
    const res = validateCombo(triad, problem, object, role, helper, friends, weather, location);
    if (!res.ok){
      if (debugRejects) rejectLog.push(`Try ${tries}: rejected — ${res.reasons.join(" | ")}`);
      continue;
    }

    // Build context & beats
    const friendName = friends.length ? friends[0].split(" (")[0] : "";
    const ctx = {
      hero: HERO,
      friendName,
      location: location.t,
      weather: weather.t,
      helper: helper.name,
      role: role.name,
      problem: problem.t,
      objectName: object ? object.name : "the goal item",
      toolName: tool ? tool.name : "a safe tool",
      vehicleName: vehicle ? vehicle.name : ""
    };

    // Title must reflect actual helper (no more “Helpful Beaver” without beaver)
    const title = buildTitle(rng, HERO, triad, helper.name, role.name, problem.t, object ? object.name : null);

    // Build beats
    const beats = buildBeats(triad, sceneCount, intensity, ctx);

    // Update manual dropdowns to current result
    document.getElementById("problemSel").value = problem.t;
    document.getElementById("roleSel").value = role.name;
    document.getElementById("helperSel").value = helper.name;
    document.getElementById("weatherSel").value = weather.t;
    document.getElementById("locationSel").value = location.t;
    if (object) document.getElementById("objectSel").value = object.name;

    // Build output
    const out = [];
    out.push("STORY TITLE");
    out.push(title);
    out.push("");
    out.push("STORY SETTINGS");
    out.push(`- Type: ${triad.label}`);
    out.push(`- Hero: ${HERO}`);
    out.push(`- Friends (optional): ${friends.length ? friends.join(", ") : "none"}`);
    out.push(`- Location: ${location.t}`);
    out.push(`- Weather/Time: ${weather.t}`);
    out.push(`- Helper (animal-only): ${helper.name}`);
    out.push(`- Primary helper role: ${role.name}`);
    out.push(`- Problem: ${problem.t}`);
    out.push(`- Object of affection: ${object ? object.name : "none"}`);
    out.push("");
    out.push("PROP DNA (must be repeated verbatim in prompts)");
    out.push(propDNA(object, tool, vehicle));
    out.push("");
    out.push(`SCENES (${beats.length})`);
    beats.forEach((b,i)=> out.push(`Scene ${i+1}: ${clean(b)}`));
    out.push("");
    out.push("SOP CHECK");
    out.push("- No dialogue, no text, no subtitles, no logos");
    out.push("- One action per scene (still/slow for detailed interaction)");
    out.push("- Visible cause → effect in every scene");
    out.push("- Physics: weight, gravity, scale are believable");
    out.push("- Animals only (photoreal anatomy, natural fur, no human limbs)");
    out.push("- Calm closing echo of opening");

    document.getElementById("output").textContent = out.join("\n");
    setStatus("Done ✅ (validated story)");
    if (debugRejects && rejectLog.length) showRejects(rejectLog.slice(-12).join("\n"));
    return;
  }

  setStatus("Could not generate a valid story (try changing seed)");
  if (document.getElementById("debugRejects").checked && rejectLog.length){
    showRejects(rejectLog.slice(-18).join("\n"));
  }
}

/* =========================================================
   Buttons
========================================================= */
document.getElementById("generateBtn").addEventListener("click", generateStory);

document.getElementById("copyBtn").addEventListener("click", async ()=>{
  const txt = document.getElementById("output").textContent || "";
  if (!txt.trim()){ setStatus("Generate first"); return; }
  try{ await navigator.clipboard.writeText(txt); setStatus("Copied ✅"); }
  catch{ setStatus("Copy failed (permissions)"); }
});

document.getElementById("toCompilerBtn").addEventListener("click", ()=>{
  const txt = document.getElementById("output").textContent || "";
  if (!txt.trim()){ setStatus("Generate first"); return; }
  const url = "./compiler.html#story=" + encodeURIComponent(txt);
  window.open(url, "_blank");
});

// generate once on load
generateStory();
</script>
</body>
</html>
