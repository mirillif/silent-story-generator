<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Silent Cinematic Cute Story Generator</title>
  <style>
    :root { --pad: 14px; --radius: 14px; }
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      margin:0; background:#0b0d12; color:#eef2ff; line-height:1.35;
    }
    header{
      padding:22px 18px; border-bottom:1px solid rgba(255,255,255,.08);
      background:
        radial-gradient(1200px 600px at 20% 0%, rgba(99,102,241,0.22), transparent 60%),
        radial-gradient(800px 400px at 80% 0%, rgba(16,185,129,0.18), transparent 55%);
    }
    header h1{ margin:0 0 6px; font-size:22px;}
    header p{ margin:0; opacity:.85; max-width:1000px;}
    a{ color:#a5b4fc; text-decoration:none;}
    a:hover{ text-decoration:underline;}

    main{ max-width:1200px; margin:0 auto; padding:18px; display:grid; gap:16px;}
    .grid{ display:grid; gap:16px; grid-template-columns:1fr; }
    @media (min-width: 980px){ .grid{ grid-template-columns: 470px 1fr; } }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .card h2{ margin:0 0 10px; font-size:15px; opacity:.95;}
    label{ font-size:12px; opacity:.85; display:block; margin-bottom:6px;}
    input, select, textarea{
      width:100%;
      padding:10px 11px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.35);
      color:#eef2ff;
      outline:none;
      box-sizing:border-box;
    }
    textarea{ min-height:110px; resize:vertical; white-space:pre-wrap; }
    .row{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width: 520px){ .row.two{ grid-template-columns:1fr 1fr; } }

    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;}
    .chip{
      display:flex; gap:8px; align-items:center;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      border-radius:999px;
      padding:7px 10px;
      font-size:12px;
    }
    .chip input{ width:auto; }

    .btnbar{ display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;}
    button{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color:#eef2ff;
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      font-weight:800;
    }
    button.primary{ background: rgba(99,102,241,.22); border-color: rgba(99,102,241,.45);}
    button.good{ background: rgba(16,185,129,.18); border-color: rgba(16,185,129,.40);}
    button.warn{ background: rgba(245,158,11,.16); border-color: rgba(245,158,11,.35);}
    button:hover{ filter:brightness(1.08); }

    .muted{ opacity:.78; font-size:12px; }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:7px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      font-size:12px;
    }
    .pill b{ font-weight:900; }
    .out{
      white-space:pre-wrap;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:12px;
      overflow:auto;
      min-height:300px;
      font-size:13px;
    }
    .k{ color:#a5b4fc; font-weight:800;}
    .hr{ height:1px; background: rgba(255,255,255,.10); margin:14px 0; }
  </style>
</head>

<body>
  <header>
    <h1>Silent Cinematic Cute Story Generator</h1>
    <p>
      Brand-locked to <span class="k">Willy / Panby / Quok</span>. Generates <span class="k">15 / 20 / 25</span> scene beats with real narrative motion
      (emotional, rescue, adventure, funny, courage, friendship). Auto-selects Problem, Helper Role, Weather, and Location with logic — still override manually.
      <br><br>
      <a href="./compiler.html">Open Prompt Compiler →</a>
    </p>
  </header>

  <main class="grid">
    <section class="card">
      <h2>1) Story Controls</h2>

      <div class="row two">
        <div>
          <label>Seed (deterministic — same seed = same story)</label>
          <input id="seed" placeholder="e.g., 2026-02-06-willy" value="willy-v2" />
          <div class="muted" style="margin-top:6px;">Tip: use a date + keyword to reproduce a story exactly.</div>
        </div>
        <div>
          <label>Story Mode (Engine)</label>
          <select id="engine">
            <option value="AUTO">Auto (best match)</option>
            <option value="EMOTIONAL">Emotional (Caregiver / Gift / Repair)</option>
            <option value="RESCUE">Rescue (Problem-solving / Tools)</option>
            <option value="ADVENTURE">Adventure (Journey / Delivery / Vehicles)</option>
            <option value="FUNNY">Funny (Mishap / Play / Surprise)</option>
            <option value="COURAGE">Courage (Hesitation → Brave step)</option>
            <option value="FRIENDSHIP">Friendship (Teamwork / Cooperation)</option>
          </select>
        </div>
      </div>

      <div class="row two" style="margin-top:10px;">
        <div>
          <label>Intensity (turning points)</label>
          <select id="intensity">
            <option value="SOFT">Soft (gentle)</option>
            <option value="MEDIUM" selected>Medium (engaging)</option>
            <option value="HIGH">High (more motion + twists)</option>
          </select>
        </div>
        <div>
          <label>Type of Story (tone)</label>
          <select id="tone">
            <option>Adventure</option>
            <option>Funny</option>
            <option>Sad</option>
            <option selected>Emotional</option>
            <option>Encouraging</option>
            <option>Brave</option>
            <option>Friendship</option>
            <option>Cozy</option>
          </select>
        </div>
      </div>

      <div class="hr"></div>

      <h2>2) Characters (brand-locked)</h2>
      <div class="chips">
        <label class="chip"><input type="checkbox" id="useWilly" checked /> Willy (always available)</label>
        <label class="chip"><input type="checkbox" id="usePanby" /> Panby (optional)</label>
        <label class="chip"><input type="checkbox" id="useQuok" /> Quok (optional)</label>
      </div>
      <div class="muted" style="margin-top:6px;">
        Willy is the channel core. Friends appear sometimes for variety.
      </div>

      <div class="hr"></div>

      <h2>3) Optional settings</h2>

      <div class="row">
        <div>
          <label>Include Object of Affection?</label>
          <div class="chips">
            <label class="chip"><input type="checkbox" id="wantObject" checked /> Yes (cute cherished object)</label>
            <label class="chip"><input type="checkbox" id="wantCountry" /> Yes: add country cultural markers</label>
          </div>
          <div class="muted" style="margin-top:6px;">
            If Object is OFF, the story will focus on a mission, relationship, or playful goal instead.
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <h2>4) Manual overrides (optional)</h2>
      <div class="row two">
        <div>
          <label>Problem Type (auto-selected; you can override)</label>
          <select id="problemSelect"></select>
        </div>
        <div>
          <label>Primary Helper Role (auto-selected; you can override)</label>
          <select id="roleSelect"></select>
        </div>
      </div>

      <div class="row two" style="margin-top:10px;">
        <div>
          <label>Weather & Time (auto-selected; you can override)</label>
          <select id="weatherSelect"></select>
        </div>
        <div>
          <label>Location (auto-selected; you can override)</label>
          <select id="locationSelect"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Helper (animal-only; auto-selected; you can override)</label>
          <select id="helperSelect"></select>
        </div>
      </div>

      <div class="row" style="margin-top:10px;">
        <div>
          <label>Object of Affection (auto-selected; you can override)</label>
          <select id="objectSelect"></select>
        </div>
      </div>

      <div class="btnbar">
        <button class="primary" id="gen15">Create Story (15 scenes)</button>
        <button class="primary" id="gen20">Create Story (20 scenes)</button>
        <button class="primary" id="gen25">Create Story (25 scenes)</button>
        <button class="good" id="copyStory">Copy Story</button>
        <button class="warn" id="sendToCompiler">Send to Compiler →</button>
      </div>

      <div style="margin-top:12px;">
        <span class="pill" id="statusPill"><b>Status:</b> Ready</span>
      </div>
      <div class="muted" style="margin-top:8px;">
        The generator uses story engines + beat maps, so scenes won’t all look the same.
      </div>
    </section>

    <section class="card">
      <h2>Output — Story Frame</h2>
      <div class="out" id="output"></div>
      <div class="muted" style="margin-top:10px;">
        This “Story Frame” is designed to paste directly into <span class="k">compiler.html</span>.
      </div>
    </section>
  </main>

<script>
/** =========================
 *  Deterministic RNG
 *  ========================= */
function hashStringToUint(seedStr){
  let h = 2166136261 >>> 0;
  for (let i=0;i<seedStr.length;i++){
    h ^= seedStr.charCodeAt(i);
    h = Math.imul(h, 16777619);
  }
  return h >>> 0;
}
function mulberry32(a){
  return function(){
    let t = a += 0x6D2B79F5;
    t = Math.imul(t ^ (t >>> 15), t | 1);
    t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
    return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
  }
}
function pick(rng, arr){
  return arr[Math.floor(rng() * arr.length)];
}
function pickMany(rng, arr, n){
  const copy = arr.slice();
  const out = [];
  for (let i=0;i<n && copy.length;i++){
    const idx = Math.floor(rng()*copy.length);
    out.push(copy.splice(idx,1)[0]);
  }
  return out;
}
function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }

/** =========================
 *  Brand DNA (fixed)
 *  ========================= */
const DNA = {
  WILLY: "WILLY: (Baby Golden Retriever puppy. Light-golden velvet-soft fluffy fur, short legs, small floppy ears. Simple RED COLLAR. SIGNATURE: A tiny pink \"blep\" tip of tongue always peeking out of his mouth).",
  PANBY: "PANBY: (Baby Giant Panda, chubby and round. Jet-black fur on limbs/eyes, snow-white fur on head/belly. Small bright YELLOW fabric bowtie).",
  QUOK: "QUOK: (Baby Quokka. Short brown-grey fur, small rounded ears, permanent gentle \"smiling\" expression)."
};

/** =========================
 *  Hundreds of options
 *  ========================= */

/* --- Helper animals (always animals) --- */
const HELPER_ANIMALS = [
  "baby duck delivery helper","red panda mechanic helper","beaver builder helper","otter lifeguard helper",
  "corgi postal helper","fox scout helper","bunny nurse helper","owl librarian helper","hedgehog electrician helper",
  "raccoon recycler helper","goat mountain guide helper","seal harbor helper","penguin snow guide helper",
  "koala comfort helper","capybara calm helper","shiba bakery helper","lamb shepherd helper","chipmunk carpenter helper",
  "turtle slow-and-steady helper","squirrel acrobat helper","deer forest ranger helper","hamster tiny engineer helper",
  "puffin coastal helper","cat firefighter helper","cat medic helper","dog park keeper helper","alpaca wool helper",
  "duck boat pilot helper","sparrow messenger helper","crane construction helper","mole tunnel helper","ferret gadget helper",
  "panda snack helper","quokka cheer helper","golden retriever big sibling helper","calico cat workshop helper"
];

/* --- Primary helper roles (120+) --- */
const HELPER_ROLES = [
  "Firefighter","Medic","Rescue Diver","Helicopter Pilot","Tow Truck Driver","Mechanic","Carpenter","Woodworker","Toy Maker",
  "Ice Cream Maker","Baker","Mail Carrier","Delivery Rider","Train Conductor","Airfield Ground Crew","Harbor Master","Lifeguard",
  "Mountain Guide","Park Ranger","Gardener","Tree Climber","Bridge Builder","Rope Specialist","Net Caster","Crane Operator",
  "Forklift Operator","Drone Operator","Balloon Operator","Boat Captain","Kayak Helper","Snow Plow Driver","Ski Patrol",
  "Weather Scout","Lantern Keeper","Lighthouse Keeper","Electrician","Plumber","Painter","Tailor","Knitwear Maker",
  "Shoe Fixer","Watchmaker","Clock Repairer","Tinker","Inventor","Engineer","Cartographer","Scout","Search Team Leader",
  "First Aid Trainer","Therapist Helper","Coach","Cheer Leader","Storyteller","Music Box Repairer","Puppet Maker","Photographer",
  "Bicycle Fixer","Skateboard Tech","Wheel Greaser","Propeller Fixer","Wing Patcher","Glue Specialist","Tape Master",
  "Sticker Artist","Button Sewer","Zipper Fixer","Backpack Packer","Snack Prepper","Hot Cocoa Maker","Tea Brewer","Soup Chef",
  "Picnic Planner","Umbrella Keeper","Raincoat Fitter","Boot Dryer","Blanket Folder","Candle Maker","Soap Maker","Perfume Mixer",
  "Flower Arranger","Balloon Twister","Kite Builder","Paper Plane Expert","Model Plane Builder","Toy Train Builder","Toy Car Tuner",
  "Mini Truck Driver","Ambulance Driver","Fire Truck Driver","Airport Shuttle Driver","Tractor Driver","Little Excavator Operator",
  "Road Painter","Traffic Cone Setter","Bridge Inspector","Tunnel Inspector","Safety Marshal","Uniform Quartermaster",
  "Helmet Fitter","Tool Librarian","Workshop Manager","Recycling Captain","Lost-and-Found Keeper","Festival Coordinator",
  "Parade Leader","Cake Decorator","Sprinkle Technician","Chocolate Maker","Jam Maker","Honey Collector","Marshmallow Roaster",
  "Star Gazer","Night Watch","Sunrise Greeter","Campfire Keeper","Sled Builder","Igloo Helper","Sandcastle Engineer"
];

/* --- Problems (50+) categorized/tags for logic --- */
const PROBLEMS = [
  // RESCUE / OUT OF REACH
  {t:"Object is out of reach on a ledge", tags:["RESCUE","PHYSICS","OUT_OF_REACH"]},
  {t:"Cherished toy is stuck in a tree", tags:["RESCUE","PHYSICS","OUT_OF_REACH"]},
  {t:"Toy vehicle rolled under a porch step", tags:["RESCUE","PHYSICS","UNDER"]},
  {t:"Kite is tangled high in branches", tags:["RESCUE","PHYSICS","OUT_OF_REACH"]},
  {t:"Important note is inside a jar that won’t open", tags:["PHYSICS","PUZZLE"]},
  {t:"A tiny bridge plank is missing over a puddle", tags:["PHYSICS","BUILD"]},
  {t:"A wagon wheel is wobbly and unsafe", tags:["PHYSICS","REPAIR"]},
  {t:"A toy plane propeller is bent", tags:["REPAIR","EMOTIONAL"]},
  {t:"A toy car’s wheel fell off", tags:["REPAIR","EMOTIONAL"]},
  {t:"A backpack strap tore", tags:["REPAIR","EMOTIONAL"]},
  {t:"A blanket got soaked and needs drying", tags:["EMOTIONAL","COZY","WEATHER"]},
  {t:"A raincoat is missing before the rain starts", tags:["WEATHER","ADVENTURE"]},
  {t:"A path is blocked by fallen branches", tags:["ADVENTURE","PHYSICS"]},
  {t:"A little boat is drifting away", tags:["RESCUE","WATER","ADVENTURE"]},
  {t:"A balloon string is slipping away", tags:["RESCUE","COMEDY","OUT_OF_REACH"]},
  // EMOTIONAL / CAREGIVER
  {t:"Favorite toy is broken and can’t be used", tags:["EMOTIONAL","CARE"]},
  {t:"A gift feels lost in the mess and must be found", tags:["EMOTIONAL","CARE","SEARCH"]},
  {t:"A tiny friend feels left out during play", tags:["EMOTIONAL","FRIENDSHIP"]},
  {t:"Hero gets scared by thunder and needs comfort", tags:["EMOTIONAL","WEATHER","COURAGE"]},
  {t:"Hero misses a friend who went home", tags:["EMOTIONAL","FRIENDSHIP"]},
  {t:"Hero feels embarrassed after a small mishap", tags:["EMOTIONAL","FUNNY"]},
  // ADVENTURE / DELIVERY
  {t:"A surprise package must reach a friend before sunset", tags:["ADVENTURE","DELIVERY"]},
  {t:"A tiny parade must start on time but props are missing", tags:["ADVENTURE","FUNNY"]},
  {t:"A picnic is planned but the basket is too heavy", tags:["ADVENTURE","PHYSICS"]},
  {t:"A model train track loop is incomplete", tags:["BUILD","ADVENTURE"]},
  {t:"A toy runway is too short for takeoff", tags:["BUILD","ADVENTURE","PHYSICS"]},
  {t:"A little sled won’t slide smoothly", tags:["REPAIR","WEATHER","ADVENTURE"]},
  // FUNNY / MISHAP
  {t:"A stack of cups keeps wobbling comically", tags:["FUNNY","PHYSICS"]},
  {t:"A hose sprays the wrong direction", tags:["FUNNY","PHYSICS"]},
  {t:"Sticky honey makes paws slip", tags:["FUNNY","PHYSICS"]},
  {t:"A rolling pin rolls away at the worst time", tags:["FUNNY","PHYSICS"]},
  {t:"A hat keeps falling over the eyes", tags:["FUNNY"]},
  // COURAGE
  {t:"A narrow step looks scary to cross", tags:["COURAGE","PHYSICS"]},
  {t:"A dark hallway feels intimidating", tags:["COURAGE","EMOTIONAL"]},
  {t:"Wind makes the kite line tug hard", tags:["COURAGE","WEATHER"]},
  // FRIENDSHIP / TEAMWORK
  {t:"Two friends want the same toy and must share", tags:["FRIENDSHIP","EMOTIONAL"]},
  {t:"A team must build something together before playtime ends", tags:["FRIENDSHIP","BUILD"]},
  // EXTRA VARIETY
  {t:"A bell on a collar fell off and needs reattaching", tags:["REPAIR","EMOTIONAL"]},
  {t:"A tiny flag won’t stand upright", tags:["PHYSICS","BUILD"]},
  {t:"A paper map got wet and must be protected", tags:["WEATHER","ADVENTURE"]},
  {t:"A lantern won’t light in the wind", tags:["WEATHER","PHYSICS"]},
  {t:"A small tunnel entrance is blocked with sand", tags:["BUILD","ADVENTURE"]},
  {t:"A toy ambulance door won’t close", tags:["REPAIR"]},
  {t:"A toy fire truck ladder won’t extend", tags:["REPAIR","RESCUE"]},
  {t:"A toy crane hook is missing", tags:["SEARCH","BUILD"]},
  {t:"A tiny cake topper slipped sideways", tags:["FUNNY","CARE"]},
  {t:"A kite tail ribbon tore", tags:["REPAIR","ADVENTURE"]},
  {t:"A wind-up toy stopped winding", tags:["REPAIR"]},
  {t:"A small bridge is too shaky to cross", tags:["PHYSICS","COURAGE"]},
  {t:"A friend’s snack spilled and needs cleanup", tags:["CARE","EMOTIONAL"]},
  {t:"A music box plays off-key and needs fixing", tags:["REPAIR","EMOTIONAL"]},
  {t:"A toy boat leaks a tiny bit", tags:["REPAIR","WATER"]},
  {t:"A balloon arch is sagging", tags:["BUILD","FUNNY"]},
  {t:"A scarf is stuck in a zipper", tags:["REPAIR","FUNNY"]},
  {t:"A small wagon is stuck in mud", tags:["PHYSICS","WEATHER","ADVENTURE"]}
];

/* --- Objects of affection (120+) --- */
const OBJECTS = [
  "tiny knitted scarf","little cape","mini plush teddy","soft bunny plush","tiny music box","paper crown","sparkly sticker sheet",
  "small wooden airplane","toy plane with blue wings","mini toy fire truck","mini toy ambulance","tiny toy tow truck","toy police car",
  "tiny toy train engine","toy sailboat","mini plush duck","small heart pillow","little bell charm","tiny lucky coin","mini storybook",
  "small photo frame","tiny ribbon bow","felt star","mini plush panda","tiny plush quokka","small hand-painted pebble","mini snow globe",
  "little lantern","tiny umbrella","mini backpack","small lunch box","tiny cookie tin","little mug with warm cocoa","mini kite",
  "toy helicopter","toy delivery van","toy bus","toy tractor","toy excavator","tiny toolbox","mini wrench","small wooden block house",
  "paper airplane","origami crane","origami heart","tiny flower bouquet","pressed leaf bookmark","small seashell","smooth river stone",
  "mini toy stroller","tiny blanket","soft bandana","little bowtie","tiny cap","small beret","mini sailor hat","toy rocket",
  "toy submarine","toy hot air balloon","toy scooter","toy skateboard","toy bicycle bell","tiny paintbrush","mini paint palette",
  "small jar of sprinkles","tiny cupcake topper","little badge","mini medal","tiny whistle","small harmonica","tiny drum","mini tambourine",
  "toy camera","mini flashlight","tiny compass","paper map","tiny key","small lock charm","mini picnic basket","tiny plush fox",
  "small plush lamb","tiny plush otter","little bracelet","tiny friendship ring","small name tag","mini notebook","tiny pencil",
  "little sticker of a star","tiny button collection","small spool of thread","tiny patch kit","mini glue tube","tiny roll of tape",
  "small bandage pack","mini first-aid pouch","tiny net","mini magnifying glass","little feather","tiny bell on a string",
  "small toy runway sign","mini traffic cone","tiny safety helmet","mini reflective vest","little rain boots","tiny scarf clip",
  "small toy lighthouse","mini toy bridge","tiny toy tunnel","mini toy garage","small plush cloud","tiny plush sun",
  "mini plush moon","small pillow shaped like a heart","tiny charm shaped like a paw","small plush starfish","tiny plush mushroom",
  "mini plush watermelon","tiny plush donut","small plush baguette","mini plush sushi","tiny plush croissant","mini plush strawberry"
];

/* --- Weather/Time (30+) with climate tags --- */
const WEATHER = [
  {t:"Spring morning, soft sunlight, mild breeze", tags:["MILD","GREEN"]},
  {t:"Warm summer afternoon, bright sun, clear sky", tags:["WARM","SUNNY"]},
  {t:"Late summer evening, golden-hour glow", tags:["WARM","SUNSET"]},
  {t:"Autumn afternoon, crisp air, falling leaves", tags:["COOL","LEAVES"]},
  {t:"Autumn morning, light mist, cool breeze", tags:["COOL","MIST"]},
  {t:"Overcast day, gentle cool light", tags:["MILD","CLOUDY"]},
  {t:"Light rain, puddles forming, soft grey sky", tags:["RAIN","COOL"]},
  {t:"Heavy rain, visible raindrops, bigger puddles", tags:["RAIN","HEAVY"]},
  {t:"Thunderstorm, dark clouds, distant lightning (safe)", tags:["STORM"]},
  {t:"Cold winter morning, pale sun, frosty air", tags:["COLD","FROST"]},
  {t:"Snowy day, soft snowfall, quiet atmosphere", tags:["SNOW","COLD"]},
  {t:"Windy day, moving grass and leaves", tags:["WIND"]},
  {t:"Foggy dawn, low visibility, diffused light", tags:["FOG","COOL"]},
  {t:"Sunny winter afternoon, cold but bright", tags:["COLD","SUNNY"]},
  {t:"Cozy indoor evening, warm lamps, soft shadows", tags:["INDOOR","COZY"]},
  {t:"Cozy indoor morning, window sunlight beams", tags:["INDOOR","COZY"]},
  {t:"Night scene, moonlight, gentle lantern glow", tags:["NIGHT"]},
  {t:"Early sunrise, pastel sky, fresh dew", tags:["MILD","SUNRISE"]},
  {t:"Hot day, shimmering heat, strong light", tags:["HOT","SUNNY"]},
  {t:"Cool seaside morning, salty air, soft light", tags:["COOL","COAST"]},
  {t:"Warm seaside afternoon, bright and breezy", tags:["WARM","COAST"]},
  {t:"Mountain morning, crisp wind, clear visibility", tags:["COOL","MOUNTAIN"]},
  {t:"Mountain evening, cold air, long shadows", tags:["COLD","MOUNTAIN"]},
  {t:"Desert sunset, warm air, long orange shadows", tags:["HOT","DESERT","SUNSET"]},
  {t:"City morning, soft haze, gentle light", tags:["MILD","CITY"]},
  {t:"Forest afternoon, dappled sunlight through leaves", tags:["MILD","FOREST"]},
  {t:"Light snow + wind, drifting flakes", tags:["SNOW","WIND","COLD"]},
  {t:"Drizzle, shiny pavement, quiet ambience", tags:["RAIN","MILD"]},
  {t:"After rain, sun breaks through, sparkling puddles", tags:["RAIN","SUNNY","MILD"]},
  {t:"Cloudy winter evening, cold blue light", tags:["COLD","CLOUDY"]}
];

/* --- Locations with country/cultural visuals + climate tags --- */
const LOCATIONS = [
  {t:"Neutral garden path — lush flowers, trimmed bushes, warm stone walkway", tags:["MILD","GREEN"], country:null},
  {t:"Cozy workshop room — wooden table, tools neatly arranged, warm daylight", tags:["INDOOR","COZY"], country:null},
  {t:"Neutral suburban backyard — short grass, wooden fence, morning light", tags:["MILD","GREEN"], country:null},
  {t:"Park meadow — soft grass, big tree, distant hills", tags:["MILD","GREEN"], country:null},
  {t:"Riverside path — smooth stones, gentle water, reeds", tags:["MILD","WATER"], country:null},
  {t:"Coastal beach — sand, driftwood, calm waves", tags:["COAST","WARM"], country:null},
  {t:"Rocky coastline — tide pools, sea spray", tags:["COAST","COOL"], country:null},
  {t:"Snowy forest clearing — pine trees, fresh snow", tags:["SNOW","COLD"], country:null},
  {t:"Mountain meadow — rocky ground, distant peaks, crisp light", tags:["MOUNTAIN","COOL"], country:null},
  {t:"Autumn forest trail — fallen leaves, earthy tones", tags:["COOL","LEAVES","FOREST"], country:null},
  {t:"City courtyard — clean pavement, planters, soft haze", tags:["CITY","MILD"], country:null},
  {t:"Farm lane — small barn, hay bales, tractor marks", tags:["MILD","GREEN"], country:null},

  // Country flavors (optional)
  {t:"Japan — traditional wooden house corridor, shoji screens, tatami floor, calm courtyard view", tags:["INDOOR","COZY","MILD"], country:"Japan"},
  {t:"Japan — quiet neighborhood lane, low walls, small shrine gate in distance", tags:["MILD","CITY"], country:"Japan"},
  {t:"France — stone village street, shutters on windows, small bakery sign shape (no text)", tags:["MILD","CITY"], country:"France"},
  {t:"Italy — warm courtyard with terracotta tiles, vines on walls", tags:["WARM","CITY"], country:"Italy"},
  {t:"UK — small garden with brick wall, vintage mailbox shape (no text)", tags:["MILD","GREEN"], country:"United Kingdom"},
  {t:"USA — suburban porch steps, white railings, driveway", tags:["MILD","CITY"], country:"United States"},
  {t:"Taiwan — alley with scooters parked (no logos), lantern shapes, warm humidity", tags:["WARM","CITY"], country:"Taiwan"},
  {t:"China — courtyard with red lantern shapes (no text), grey brick, calm morning haze", tags:["MILD","CITY"], country:"China"},
  {t:"Korea — hanok-style courtyard, wooden beams, stone stepping path", tags:["MILD","CITY"], country:"Korea"},
  {t:"Spain — bright plaza corner, warm stucco walls, potted plants", tags:["WARM","CITY"], country:"Spain"},
  {t:"Morocco — sunlit courtyard, patterned tile floor, warm desert air", tags:["HOT","DESERT"], country:"Morocco"},
  {t:"Norway — snowy cabin exterior, pine trees, quiet cold air", tags:["SNOW","COLD"], country:"Norway"}
];

/** =========================
 *  Engines + beat maps
 *  ========================= */
const ENGINES = {
  EMOTIONAL: {
    name:"Emotional (Caregiver / Gift / Repair)",
    tags:["EMOTIONAL","CARE"],
    beatTemplate: function(n){
      // Build/repair / comfort curve
      const base = [
        "Calm opening in {LOCATION}. {HERO} is still, looking around.",
        "{HERO} is shown near the cherished focus. The environment matches: {WEATHER}.",
        "The problem becomes clear: {PROBLEM}. {HERO} pauses, ears and posture showing sadness or worry.",
        "{HERO} sits very still and looks down at {OBJECT}, body small and quiet.",
        "{HELPER} notices {HERO}'s posture and moves closer slowly.",
        "{HELPER} sits near {HERO} in a comforting way, both looking at {OBJECT} (not the camera).",
        "{HELPER} stands and turns toward a place with tools or materials, showing a gentle decision.",
        "{HELPER} prepares a role-fitting tool or vehicle for {ROLE} (one clear action).",
        "{HELPER} begins a careful build/repair step (one action).",
        "{HELPER} continues the build/repair with visible progress (one action).",
        "{HELPER} adds a finishing detail to make it extra cute and safe (one action).",
        "{HELPER} tests the result gently, showing it works (one action).",
        "{HELPER} reveals the repaired/new {OBJECT} to {HERO}.",
        "{HERO} reacts with visible joy—tail wag, soft eyes, tiny blep—then moves closer slowly.",
        "Calm closing echo: {HERO} stays near {HELPER}, both relaxed in {LOCATION} under {WEATHER}."
      ];
      return stretchToN(base, n, [
        // extra “making” beats for 20/25
        "{HELPER} measures or aligns parts carefully on a flat surface (one action).",
        "{HELPER} tightens or secures a small piece so it won’t fall off (one action).",
        "{HELPER} gently cleans dust or water from {OBJECT} (one action).",
        "{HERO} watches closely, staying still, eyes tracking the helper’s paws.",
        "{HELPER} adds a soft safety element (padding/strap) so physics feels believable."
      ]);
    }
  },
  RESCUE: {
    name:"Rescue (Attempts / Tools / Success)",
    tags:["RESCUE","PHYSICS"],
    beatTemplate: function(n){
      const base = [
        "Calm opening in {LOCATION}. {HERO} trots slowly, scanning the area.",
        "{HERO} notices {OBJECT} and moves closer, head tilting.",
        "Cause: {HERO} makes one small attempt to reach {OBJECT}.",
        "Effect: {PROBLEM} becomes obvious with realistic gravity.",
        "{HERO} freezes briefly, ears angled back, then looks around for help.",
        "{HELPER} arrives with purposeful movement, wearing a role-fitting vibe for {ROLE}.",
        "{HELPER} prepares a cute tool or vehicle (one action).",
        "Movement shot: {HELPER} approaches the problem spot; camera stays static/slow.",
        "Attempt 1: {HELPER} tries a simple solution (one action) — it fails visibly.",
        "Reaction: {HELPER} pauses, looks at {OBJECT}, then repositions (still/slow).",
        "Attempt 2: {HELPER} adds a small adjustment (net/rope/angle/stack).",
        "Cause→effect: the adjustment changes the outcome but not enough yet.",
        "Attempt 3: {HELPER} uses the best angle/lever/traction (one action).",
        "Success: the solution works — {OBJECT} is recovered safely.",
        "{HERO} receives {OBJECT} with visible relief and joy; calm closing in {LOCATION}."
      ];
      return stretchToN(base, n, [
        "{HELPER} brings a second item (cone/board/strap) to stabilize the setup (one action).",
        "A tiny slip happens; {HELPER} catches it quickly so physics feels real (one action).",
        "{HERO} stays still to avoid wobbling the setup, eyes locked on the object.",
        "{HELPER} changes tool mode (extend/flip/open) with a clear mechanical movement (one action)."
      ]);
    }
  },
  ADVENTURE: {
    name:"Adventure (Journey / Delivery / Vehicles)",
    tags:["ADVENTURE","DELIVERY"],
    beatTemplate: function(n){
      const base = [
        "Calm opening in {LOCATION}. {HERO} is near a small goal item: {OBJECT}.",
        "{HERO} looks toward the distance, then back at {OBJECT}, showing a mission.",
        "Cause: {HERO} starts moving with purpose along the path (one motion).",
        "Effect: a small obstacle appears related to {PROBLEM}.",
        "{HELPER} appears with a role vibe for {ROLE} and gestures toward a vehicle.",
        "{HELPER} sets up a tiny vehicle or transport tool (one action).",
        "Movement shot: {HELPER} leads the way; {HERO} follows slowly.",
        "Obstacle beat: the path requires one clear fix (board/rope/bridge).",
        "Solution beat: {HELPER} performs the fix (one action).",
        "Travel continues: wheels/steps move forward; camera slow and stable.",
        "New obstacle: wind/water/terrain creates a second challenge (one action revealed).",
        "Adjustment: {HELPER} changes approach (angle/route/traction).",
        "Near destination: {HERO} sees the goal area and speeds up slightly.",
        "Success: mission completed — safe arrival/delivery of {OBJECT}.",
        "Calm closing echo in {LOCATION} under {WEATHER}."
      ];
      return stretchToN(base, n, [
        "A cute transport prop appears (toy truck/plane/boat) and is set in motion (one action).",
        "{HERO} pauses at a tricky spot, then takes one brave step forward (one action).",
        "{HELPER} signals a safe route and nudges a marker cone into place (one action).",
        "The vehicle slows, then rolls forward again, showing believable weight and inertia."
      ]);
    }
  },
  FUNNY: {
    name:"Funny (Mishap / Play / Surprise)",
    tags:["FUNNY","PLAY"],
    beatTemplate: function(n){
      const base = [
        "Calm opening in {LOCATION}. {HERO} spots {OBJECT} and wags slightly.",
        "{HERO} does one playful action with {OBJECT} (nudge/paw tap).",
        "Cause: a tiny mishap begins related to {PROBLEM}.",
        "Effect: the mishap becomes visible and silly (but safe).",
        "{HERO} freezes with a funny posture—head tilt, blep visible.",
        "{HELPER} arrives and watches for a second, then moves in.",
        "{HELPER} prepares a cute tool/vehicle for {ROLE} (one action).",
        "Attempt: {HELPER} tries a fix (one action) — it makes it slightly worse in a harmless way.",
        "Reaction: both characters pause and stare at the result (still/slow).",
        "Adjustment: {HELPER} changes method (one clear action).",
        "Cause→effect: the new method works partway.",
        "Final tiny tweak: {HELPER} repositions to perfect it (one action).",
        "Success: the silly problem resolves cleanly.",
        "{HERO} does a small happy bounce or tail wag (one motion).",
        "Calm closing echo with both relaxed in {LOCATION}."
      ];
      return stretchToN(base, n, [
        "A tiny cone slides; {HELPER} catches it before it tips (one action).",
        "{HERO} steps back politely so the fix can happen (one action).",
        "A small vehicle rolls a bit too far, then stops from friction (one action).",
        "Both share a cute synchronized head tilt (still/slow)."
      ]);
    }
  },
  COURAGE: {
    name:"Courage (Hesitation → Brave step)",
    tags:["COURAGE","EMOTIONAL"],
    beatTemplate: function(n){
      const base = [
        "Calm opening in {LOCATION}. {HERO} approaches slowly under {WEATHER}.",
        "{HERO} sees the challenge related to {PROBLEM} and stops.",
        "Body language: {HERO}'s ears dip slightly; he holds still, looking at the obstacle (not camera).",
        "{HELPER} arrives quietly and stands beside {HERO} without rushing.",
        "{HELPER} demonstrates a safe micro-step (one action).",
        "{HERO} copies the micro-step (one action), still cautious.",
        "Cause: a second micro-step is attempted.",
        "Effect: progress is visible, but the obstacle remains.",
        "{HELPER} adds a simple safety tool/marker (one action).",
        "{HERO} takes the brave step (one action), then pauses to breathe.",
        "Relief beat: {HERO} relaxes posture; tail moves gently.",
        "{HELPER} completes the final support action (one action).",
        "Success: {OBJECT} or goal is reached safely.",
        "{HERO} shows proud joy—soft eyes, calm tail wag, tiny blep.",
        "Calm closing echo in {LOCATION} under {WEATHER}."
      ];
      return stretchToN(base, n, [
        "{HELPER} positions a board/step for stability (one action).",
        "{HERO} pauses and looks to {HELPER} for reassurance (still/slow).",
        "A light gust or sound happens; {HERO} steadies himself (one action)."
      ]);
    }
  },
  FRIENDSHIP: {
    name:"Friendship (Teamwork / Cooperation)",
    tags:["FRIENDSHIP","TEAM"],
    beatTemplate: function(n){
      const base = [
        "Calm opening in {LOCATION}. {HERO} is present with a friendly atmosphere under {WEATHER}.",
        "{HERO} notices {OBJECT} and pauses, looking thoughtful in posture.",
        "{FRIEND} appears nearby and looks at {HERO}, then at {OBJECT}.",
        "Cause: {HERO} makes one attempt related to {PROBLEM}.",
        "Effect: the challenge is clearer; both stay still and look at the problem (not camera).",
        "{HELPER} arrives as a gentle coordinator with role vibe for {ROLE}.",
        "{HELPER} indicates a simple teamwork plan using body language.",
        "Team action 1: {HERO} holds still while {FRIEND} repositions something (one action).",
        "Team action 2: {HELPER} adds a tool/vehicle (one action).",
        "Attempt: the team tries the fix (one action) — partial progress.",
        "Pause: all three look at the result, then adjust positions slowly.",
        "Final team action: one small adjustment completes the solution (one action).",
        "Success: {OBJECT} is safe/recovered/working.",
        "{HERO} and {FRIEND} share a cute calm moment of joy (still/slow).",
        "Calm closing echo in {LOCATION}."
      ];
      return stretchToN(base, n, [
        "The friend does a tiny supportive nudge to help (one action).",
        "{HELPER} places two small cones to mark safe spots (one action).",
        "A small vehicle rolls forward together with everyone watching (one action)."
      ]);
    }
  }
};

/** =========================
 *  Beat helpers
 *  ========================= */
function stretchToN(baseBeats, n, extras){
  if (baseBeats.length === n) return baseBeats.slice();
  const beats = baseBeats.slice();
  if (beats.length < n){
    const need = n - beats.length;
    // Insert extras near the middle for variety
    const mid = Math.floor(beats.length/2);
    const insert = extras.slice(0, need);
    beats.splice(mid, 0, ...insert);
  } else {
    // If too many, trim from the middle gently (keep opening + closing)
    const keepHead = 4;
    const keepTail = 4;
    const midLen = n - keepHead - keepTail;
    const head = beats.slice(0, keepHead);
    const tail = beats.slice(beats.length-keepTail);
    const middle = beats.slice(keepHead, beats.length-keepTail).slice(0, midLen);
    return head.concat(middle, tail);
  }
  return beats.slice(0, n);
}

function setStatus(t){ document.getElementById("statusPill").innerHTML = "<b>Status:</b> " + t; }

function titleCase(s){
  return (s||"").split(" ").map(w=>w ? w[0].toUpperCase()+w.slice(1) : w).join(" ");
}

function sanitizeLine(s){ return (s||"").replace(/\s+/g," ").trim(); }

function locationCompatible(weatherTags, locTags){
  // Hard constraints: snow/cold cannot be beach warm; desert/hot not snowy, etc.
  const w = new Set(weatherTags);
  const l = new Set(locTags);

  if (w.has("SNOW") && (l.has("COAST") || l.has("HOT") || l.has("DESERT") || l.has("WARM"))) return false;
  if (w.has("HOT") && (l.has("SNOW") || l.has("COLD"))) return false;
  if (w.has("COAST") && (l.has("SNOW") || l.has("MOUNTAIN") && w.has("SNOW"))) return false;

  // Indoor weather: prefer indoor locations
  if (w.has("INDOOR") && !l.has("INDOOR")) return false;

  // Mountain weather: prefer mountain location sometimes, but not mandatory
  return true;
}

function pickCompatibleLocation(rng, weather){
  const wTags = weather.tags || [];
  // First try strict compatible
  const candidates = LOCATIONS.filter(loc => locationCompatible(wTags, loc.tags||[]));
  return pick(rng, candidates.length ? candidates : LOCATIONS);
}

function pickWeatherForLocation(rng, loc){
  const lTags = new Set(loc.tags||[]);
  let candidates = WEATHER.slice();

  // If location is snow/cold, bias to cold/snow
  if (lTags.has("SNOW") || lTags.has("COLD")){
    candidates = WEATHER.filter(w => (w.tags||[]).includes("COLD") || (w.tags||[]).includes("SNOW"));
  }
  if (lTags.has("COAST")){
    candidates = WEATHER.filter(w => (w.tags||[]).includes("COAST"));
    if (!candidates.length) candidates = WEATHER.slice();
  }
  if (lTags.has("INDOOR")){
    candidates = WEATHER.filter(w => (w.tags||[]).includes("INDOOR"));
  }

  return pick(rng, candidates.length ? candidates : WEATHER);
}

function pickEngine(rng, requestedEngine, tone){
  if (requestedEngine && requestedEngine !== "AUTO") return requestedEngine;
  // Auto: choose based on tone with some randomness
  const t = (tone||"").toLowerCase();
  const weighted = [];
  function add(e, w){ for (let i=0;i<w;i++) weighted.push(e); }

  if (t.includes("emotional") || t.includes("sad") || t.includes("cozy")) { add("EMOTIONAL", 6); add("FRIENDSHIP", 2); add("COURAGE", 2); }
  else if (t.includes("funny")) { add("FUNNY", 6); add("ADVENTURE", 2); add("RESCUE", 2); }
  else if (t.includes("brave") || t.includes("encouraging")) { add("COURAGE", 6); add("RESCUE", 3); add("FRIENDSHIP", 1); }
  else if (t.includes("friend")) { add("FRIENDSHIP", 6); add("EMOTIONAL", 2); add("FUNNY", 2); }
  else if (t.includes("adventure")) { add("ADVENTURE", 6); add("RESCUE", 3); add("FUNNY", 1); }
  else { add("RESCUE", 3); add("EMOTIONAL", 3); add("ADVENTURE", 2); add("FUNNY", 2); }

  return pick(rng, weighted);
}

function problemCandidatesForEngine(engineKey, wantObject){
  const e = ENGINES[engineKey];
  const tags = new Set(e.tags || []);
  return PROBLEMS.filter(p=>{
    const ptags = new Set(p.tags||[]);
    // Prefer match of engine tags
    const matches = [...tags].some(t => ptags.has(t)) || (engineKey==="AUTO");
    if (!matches) return false;

    // If no object, avoid “object stuck” style problems (but not strictly)
    if (!wantObject && ptags.has("OUT_OF_REACH")) return false;
    return true;
  });
}

function pickProblem(rng, engineKey, wantObject){
  const candidates = problemCandidatesForEngine(engineKey, wantObject);
  return pick(rng, candidates.length ? candidates : PROBLEMS);
}

function pickRole(rng, engineKey, problem){
  const ptags = new Set(problem.tags||[]);
  const candidates = HELPER_ROLES.filter(r=>{
    const low = r.toLowerCase();
    if (ptags.has("RESCUE")) return /rescue|fire|medic|pilot|tow|lifeguard|ranger|marshal|diver|crane|rope/i.test(r);
    if (ptags.has("REPAIR")) return /mechanic|repair|fix|tinker|engineer|carpenter|wood|inventor|tool/i.test(r);
    if (ptags.has("DELIVERY")) return /delivery|mail|carrier|conductor|captain|shuttle/i.test(r);
    if (ptags.has("CARE") || engineKey==="EMOTIONAL") return /maker|tailor|baker|cocoa|tea|blanket|quartermaster|toy|story|coach/i.test(r);
    if (engineKey==="FUNNY") return /maker|baker|sprinkle|parade|festival|balloon/i.test(r);
    if (engineKey==="COURAGE") return /guide|ranger|coach|marshal|night watch|weather scout/i.test(r);
    if (engineKey==="FRIENDSHIP") return /coordinator|manager|coach|ranger|marshal|planner/i.test(r) || /builder|maker/i.test(r);
    return true;
  });
  return pick(rng, candidates.length ? candidates : HELPER_ROLES);
}

function pickHelperAnimal(rng, role){
  // Simple pairing bias: if role suggests fire/medic -> cat/dog; build -> beaver; delivery -> duck/corgi; snow -> penguin
  const r = (role||"").toLowerCase();
  const candidates = HELPER_ANIMALS.filter(a=>{
    const al = a.toLowerCase();
    if (r.includes("fire")) return al.includes("cat firefighter") || al.includes("dog") || al.includes("cat");
    if (r.includes("medic") || r.includes("first aid")) return al.includes("bunny nurse") || al.includes("cat medic") || al.includes("dog");
    if (r.includes("carpenter") || r.includes("wood") || r.includes("builder")) return al.includes("beaver") || al.includes("chipmunk") || al.includes("mole");
    if (r.includes("delivery") || r.includes("mail")) return al.includes("duck delivery") || al.includes("corgi postal") || al.includes("sparrow messenger");
    if (r.includes("lifeguard") || r.includes("harbor") || r.includes("boat")) return al.includes("otter") || al.includes("seal") || al.includes("duck boat");
    if (r.includes("snow") || r.includes("ski") || r.includes("sled")) return al.includes("penguin") || al.includes("seal") || al.includes("turtle");
    return true;
  });
  return pick(rng, candidates.length ? candidates : HELPER_ANIMALS);
}

function pickObject(rng, wantObject){
  if (!wantObject) return null;
  return pick(rng, OBJECTS);
}

function pickFriends(rng){
  const usePanby = document.getElementById("usePanby").checked;
  const useQuok  = document.getElementById("useQuok").checked;
  const friends = [];
  if (usePanby) friends.push("Panby (Baby Giant Panda)");
  if (useQuok) friends.push("Quok (Baby Quokka)");
  // If none selected, sometimes add one friend for variety (rare)
  if (!friends.length && rng() < 0.18){
    friends.push(pick(rng, ["Panby (Baby Giant Panda)","Quok (Baby Quokka)"]));
  }
  return friends;
}

function buildTitle(rng, heroName, engineKey, problemText, objectText){
  const patterns = [
    "{HERO} and the {ADJ} {OBJECT}",
    "{HERO}'s {OBJECT} Mission",
    "{HERO} and the Day of the {OBJECT}",
    "{HERO} and the {ADJ} Rescue",
    "{HERO} Learns a Brave Step",
    "{HERO} and a Warm Surprise",
    "{HERO} and the Helpful {HELPER_KIND}",
    "{HERO} and the Little Problem That Became a Big Smile"
  ];
  const adj = pick(rng, ["Brave","Tiny","Heartfelt","Cozy","Sparkly","Lucky","Gentle","Wholesome","Sweet","Clever"]);
  const helperKind = pick(rng, ["Duck","Beaver","Otter","Bunny","Red Panda","Owl","Hedgehog","Corgi"]);
  const object = objectText ? titleCase(objectText.replace(/^tiny |^mini |^small |^little /i,"")) : titleCase(pick(rng, ["Journey","Plan","Gift","Surprise","Friendship","Rescue","Adventure"]));
  let p = pick(rng, patterns);
  p = p.replaceAll("{HERO}", heroName)
       .replaceAll("{ADJ}", adj)
       .replaceAll("{OBJECT}", object)
       .replaceAll("{HELPER_KIND}", helperKind);
  // Optionally include problem hint
  if (rng() < 0.30){
    p += " — " + problemText;
  }
  return sanitizeLine(p);
}

function applyPlaceholders(beat, ctx){
  return beat
    .replaceAll("{LOCATION}", ctx.location)
    .replaceAll("{WEATHER}", ctx.weather)
    .replaceAll("{PROBLEM}", ctx.problem)
    .replaceAll("{OBJECT}", ctx.object || "the goal item")
    .replaceAll("{ROLE}", ctx.role)
    .replaceAll("{HELPER}", ctx.helper)
    .replaceAll("{HERO}", ctx.hero)
    .replaceAll("{FRIEND}", ctx.friend || ctx.hero);
}

function formatStoryFrame(ctx, sceneLines){
  const lines = [];
  lines.push("STORY TITLE");
  lines.push(ctx.title);
  lines.push("");
  lines.push("STORY SETTINGS");
  lines.push(`- Type: ${ctx.tone}`);
  lines.push(`- Hero: ${ctx.hero}`);
  if (ctx.friends && ctx.friends.length){
    lines.push(`- Friends (optional): ${ctx.friends.join(", ")}`);
  } else {
    lines.push(`- Friends (optional): none`);
  }
  lines.push(`- Location: ${ctx.location}`);
  lines.push(`- Weather/Time: ${ctx.weather}`);
  lines.push(`- Helper (animal-only): ${ctx.helper}`);
  lines.push(`- Primary helper role: ${ctx.role}`);
  lines.push(`- Problem: ${ctx.problem}`);
  lines.push(`- Object of affection: ${ctx.object ? ctx.object : "none"}`);
  lines.push("");
  lines.push(`SCENES (${sceneLines.length})`);
  sceneLines.forEach((s,i)=> lines.push(`Scene ${i+1}: ${s}`));
  lines.push("");
  lines.push("SOP CHECK");
  lines.push("- No dialogue, no text, no subtitles, no logos");
  lines.push("- One action per scene (still/slow for detailed interaction)");
  lines.push("- Visible cause → effect in every scene");
  lines.push("- Physics: weight, gravity, scale are believable");
  lines.push("- Animals only (photoreal anatomy, natural fur, no human limbs)");
  lines.push("- Calm closing echo of opening");
  return lines.join("\n");
}

/** =========================
 *  UI population
 *  ========================= */
function fillSelect(selectId, items, getLabel){
  const sel = document.getElementById(selectId);
  sel.innerHTML = "";
  items.forEach((it)=>{
    const opt = document.createElement("option");
    opt.value = typeof it === "string" ? it : JSON.stringify(it);
    opt.textContent = getLabel ? getLabel(it) : (typeof it === "string" ? it : it.t);
    sel.appendChild(opt);
  });
}

function initOptions(){
  fillSelect("problemSelect", PROBLEMS, it => it.t);
  fillSelect("roleSelect", HELPER_ROLES, it => it);
  fillSelect("weatherSelect", WEATHER, it => it.t);
  fillSelect("locationSelect", LOCATIONS, it => it.t);
  fillSelect("helperSelect", HELPER_ANIMALS, it => it);
  fillSelect("objectSelect", OBJECTS, it => it);
}
initOptions();

/** =========================
 *  Generation
 *  ========================= */
function generateStory(sceneCount){
  try{
    setStatus("Generating…");
    const seedStr = (document.getElementById("seed").value || "willy-v2") + "|" + sceneCount;
    const rng = mulberry32(hashStringToUint(seedStr));

    const wantObject = document.getElementById("wantObject").checked;
    const wantCountry = document.getElementById("wantCountry").checked;

    const tone = document.getElementById("tone").value;
    const engineReq = document.getElementById("engine").value;
    const intensity = document.getElementById("intensity").value;

    const engineKey = pickEngine(rng, engineReq, tone);

    // Characters
    const hero = "Willy (Baby Golden Retriever)";
    const friends = pickFriends(rng);

    // Auto selections
    let problem = pickProblem(rng, engineKey, wantObject);
    let role = pickRole(rng, engineKey, problem);
    let helper = pickHelperAnimal(rng, role);

    // Location/weather: pick compatible pair
    // If country optional ON, allow country-flavor locations sometimes
    let locPool = LOCATIONS.slice();
    if (!wantCountry){
      locPool = locPool.filter(l => !l.country);
      if (!locPool.length) locPool = LOCATIONS.slice();
    }
    // pick weather first sometimes, else location first
    let location, weather;
    if (rng() < 0.5){
      // choose weather, then compatible location
      weather = pick(rng, WEATHER);
      location = pickCompatibleLocation(rng, weather);
      // if location country off, re-pick from locPool with compatibility
      const compatPool = locPool.filter(l => locationCompatible(weather.tags||[], l.tags||[]));
      location = pick(rng, compatPool.length ? compatPool : locPool);
    } else {
      // choose location, then weather that fits it
      location = pick(rng, locPool);
      weather = pickWeatherForLocation(rng, location);
    }

    // Object of affection
    let object = pickObject(rng, wantObject);

    // Manual overrides if user changed select (we treat current selected values as override)
    const overrideProblem = document.getElementById("problemSelect").value;
    const overrideRole = document.getElementById("roleSelect").value;
    const overrideWeather = document.getElementById("weatherSelect").value;
    const overrideLocation = document.getElementById("locationSelect").value;
    const overrideHelper = document.getElementById("helperSelect").value;
    const overrideObject = document.getElementById("objectSelect").value;

    // Apply overrides ONLY if user has interacted? (simple approach: always treat current selection as override if not empty)
    // But we also auto-update the selects after generation so user sees what was chosen.
    // We'll apply overrides if user is not on default auto state "AUTO"?? We'll keep it flexible:
    // Use override only if user changed it away from our auto after last generation is hard to detect without state.
    // Here: we provide a toggle behavior: if user keeps selects as-is, they can override by selecting and generating again.
    // So first generation uses auto; but we will set selects to auto values before output.
    // To keep behavior predictable: we DO NOT override on first pass. We only show auto-selected in dropdown.
    // If you want override, select your choices then click generate again — then we use dropdowns.
    const useOverrides = document.body.dataset.usedOnce === "1";
    if (useOverrides){
      // Problem
      const p = JSON.parseSafe ? null : null; // no-op
      const probObj = PROBLEMS.find(x=>x.t===overrideProblem);
      if (probObj) problem = probObj;
      if (overrideRole) role = overrideRole;
      if (overrideHelper) helper = overrideHelper;

      const wObj = WEATHER.find(x=>x.t===overrideWeather);
      if (wObj) weather = wObj;

      const lObj = LOCATIONS.find(x=>x.t===overrideLocation);
      if (lObj) location = lObj;

      if (wantObject && overrideObject) object = overrideObject;
      if (!wantObject) object = null;
    }

    // Intensity affects: add extra “turns” via engine choice + some wording variety
    let bonusFriend = null;
    if (engineKey === "FRIENDSHIP"){
      bonusFriend = friends.length ? (friends[0].includes("Panby") ? "Panby (Baby Giant Panda)" : "Quok (Baby Quokka)") : pick(rng, ["Panby (Baby Giant Panda)","Quok (Baby Quokka)"]);
    }

    // Build beats
    const engine = ENGINES[engineKey];
    let beats = engine.beatTemplate(sceneCount);

    // Intensity: inject more action verbs / extra twists by replacing some beats
    if (intensity === "HIGH"){
      beats = beats.map((b, idx)=>{
        if (idx===2 && rng()<0.7) return b + " The movement is slightly faster, but still readable and realistic.";
        if (idx===8 && rng()<0.7) return b.replace("fails visibly", "fails visibly with a small slip or wobble that stays safe");
        return b;
      });
    } else if (intensity === "SOFT"){
      beats = beats.map((b, idx)=>{
        if (idx===8 && rng()<0.6) return b.replace("fails visibly", "does not work yet, and the helper pauses gently");
        return b;
      });
    }

    // Context for placeholder injection
    const ctx = {
      tone,
      engine: engineKey,
      hero,
      friends,
      friend: bonusFriend || (friends.length ? friends[0].split(" (")[0] : "a friend"),
      location: location.t,
      weather: weather.t,
      helper,
      role,
      problem: problem.t,
      object: object
    };

    // Make title
    ctx.title = buildTitle(rng, "Willy", engineKey, problem.t, object);

    // Render scenes
    const sceneLines = beats.map(b => sanitizeLine(applyPlaceholders(b, ctx)));

    // Update dropdowns to show selected (auto or override)
    document.getElementById("problemSelect").value = problem.t;
    document.getElementById("roleSelect").value = role;
    document.getElementById("weatherSelect").value = weather.t;
    document.getElementById("locationSelect").value = location.t;
    document.getElementById("helperSelect").value = helper;
    document.getElementById("objectSelect").value = object ? object : document.getElementById("objectSelect").value;

    // Output
    const output = formatStoryFrame(ctx, sceneLines);
    document.getElementById("output").textContent = output;

    document.body.dataset.usedOnce = "1";
    setStatus("Done ✅ (copy or send to compiler)");
  } catch (e){
    console.error(e);
    setStatus("Error: " + (e && e.message ? e.message : e));
  }
}

// Button wiring
document.getElementById("gen15").addEventListener("click", ()=> generateStory(15));
document.getElementById("gen20").addEventListener("click", ()=> generateStory(20));
document.getElementById("gen25").addEventListener("click", ()=> generateStory(25));

document.getElementById("copyStory").addEventListener("click", async ()=>{
  const txt = document.getElementById("output").textContent || "";
  if (!txt.trim()){ setStatus("Nothing to copy — generate first."); return; }
  try{
    await navigator.clipboard.writeText(txt);
    setStatus("Copied ✅");
  } catch {
    setStatus("Copy failed (browser permission). Select text manually and copy.");
  }
});

document.getElementById("sendToCompiler").addEventListener("click", ()=>{
  const txt = document.getElementById("output").textContent || "";
  if (!txt.trim()){ setStatus("Generate a story first."); return; }
  const url = "./compiler.html#story=" + encodeURIComponent(txt);
  window.open(url, "_blank");
});

// Pre-generate a first story for convenience
generateStory(15);
</script>
</body>
</html>
